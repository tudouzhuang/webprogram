<!DOCTYPE html>
<html lang="en">
  <head>
    <title>登录</title>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="Portal - Bootstrap 5 Admin Dashboard Template For Developers" />
    <meta name="author" content="Xiaoying Riley at 3rd Wave Media" />
    <link rel="shortcut icon" href="favicon.ico" />
    <script defer src="assets/plugins/fontawesome/js/all.min.js"></script>
    <link id="theme-style" rel="stylesheet" href="assets/css/portal.css" />
  </head>

  <body class="app app-login p-0">
    <div class="row g-0 app-auth-wrapper">
      <div class="col-12 col-md-7 col-lg-6 auth-main-col text-center p-5">
        <div class="d-flex flex-column align-content-end">
          <div class="app-auth-body mx-auto">
            <div class="app-auth-branding mb-4">
              <a class="app-logo" href="index.html">
                <img class="logo-icon me-2" src="assets/images/app-logo.svg" alt="logo" />
              </a>
            </div>
            <h2 class="auth-heading text-center mb-5">登录</h2>
            <div class="auth-form-container text-start">
              <!-- 表单的 id 保持，以便JS能找到它 -->
              <form class="auth-form login-form" id="login-form">
                <div class="email mb-3">
                  <label class="sr-only" for="username">用户名</label>
                  <!-- id 和 name 保持为 "username" -->
                  <input
                    id="username"
                    name="username"
                    type="text"
                    class="form-control signin-username"
                    placeholder="请输入您的用户名"
                    required="required"
                  />
                </div>
                <div class="password mb-3">
                  <label class="sr-only" for="password">密码</label>
                   <!-- id 和 name 保持为 "password" -->
                  <input
                    id="password"
                    name="password"
                    type="password"
                    class="form-control signin-password"
                    placeholder="请输入密码"
                    required="required"
                  />
                  <div class="extra mt-3 row justify-content-between">
                    <div class="col-6">
                      <div class="form-check">
                        <input class="form-check-input" type="checkbox" value="" id="RememberPassword" />
                        <label class="form-check-label" for="RememberPassword">记住我</label>
                      </div>
                    </div>
                    <div class="col-6">
                      <div class="forgot-password text-end">
                        <a href="reset-password.html" style="text-decoration: none">忘记密码？</a>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="text-center">
                  <button type="submit" class="btn app-btn-primary w-100 theme-btn mx-auto">
                    登录
                  </button>
                </div>
              </form>
              <div class="auth-option text-center pt-5">
                没有账户？ <a class="text-link" href="signup.html">注册一个</a>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-12 col-md-5 col-lg-6 h-100 auth-background-col">
        <div class="auth-background-holder"></div>
        <div class="auth-background-mask"></div>
        <div class="auth-background-overlay p-3 p-lg-5">
          <div class="d-flex flex-column align-content-end h-100">
            <div class="h-100"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- ================================================================== -->
    <!--   ↓↓↓ 最终版的 JavaScript 登录逻辑 ↓↓↓   -->
    <!-- ================================================================== -->

    <!-- 1. 引入 Axios 库 -->
    <script src="/material/axios.min.js"></script>

    <!-- 2. 登录逻辑脚本 -->
    <script>
        const loginForm = document.getElementById('login-form');
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');

        loginForm.addEventListener('submit', function(event) {
            // 阻止表单默认的刷新行为
            event.preventDefault();

            // 从输入框获取值
            const username = usernameInput.value;
            const password = passwordInput.value;

            // 简单的前端非空验证
            if (!username || !password) {
                alert('用户名和密码不能为空！');
                return;
            }

            // 【关键】使用 URLSearchParams 来构造 x-www-form-urlencoded 格式的数据
            // Spring Security 默认需要这种格式
            const params = new URLSearchParams();
            params.append('username', username);
            params.append('password', password);

            // 发送 POST 请求到 SecurityConfig 中配置的 loginProcessingUrl
            axios.post('/api/users/login', params)
                .then(function(response) {
                    // --- 请求成功 (HTTP 状态码 200 OK) ---
                    console.log('登录成功，后端返回:', response.data);
                    
                    // 【关键】检查后端返回的JSON数据
                    if (response.data && response.data.success) {
                        // 如果后端明确告知成功，则进行跳转
                        // 跳转到后端指定的 redirectUrl
                        window.location.href = response.data.redirectUrl || '/index';
                    } else {
                        // 如果后端返回了成功状态码但业务上失败，显示后端消息
                        alert(response.data.message || '登录失败，未知错误。');
                    }
                })
                .catch(function(error) {
                    // --- 请求失败 (HTTP 状态码 401, 500 等) ---
                    console.error('登录请求失败:', error);
                    
                    // 尝试从失败响应中获取后端返回的错误信息
                    let errorMessage = '用户名或密码不正确，请重试。';
                    if (error.response && error.response.data && error.response.data.message) {
                        errorMessage = error.response.data.message;
                    }
                    
                    alert(errorMessage);
                });
        });
    </script>
  </body>
</html>