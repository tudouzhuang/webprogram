<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <title>审查系统 - 安全登录</title>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Audit System Login" />
  <meta name="author" content="System Admin" />
  <link rel="shortcut icon" href="favicon.ico" />
  <script src="assets/plugins/fontawesome/js/all.min.js"></script>
  <link id="theme-style" rel="stylesheet" href="assets/css/portal.css" />

  <style>
    /* --- [绝对保留] 核心逻辑样式 (勿动) --- */
    .toast-container {
      z-index: 9999;
    }

    .toast.bg-success .toast-header {
      background-color: #198754;
      color: white;
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
    }

    .toast.bg-danger .toast-header {
      background-color: #dc3545;
      color: white;
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
    }

    .toast-header .btn-close {
      filter: invert(1) grayscale(100%) brightness(200%);
    }

    #debug-area {
      display: none;
      font-size: 12px;
      text-align: left;
      word-break: break-all;
    }

    /* --- 界面美化样式 (Review System Theme - Typography Enhanced) --- */
    :root {
      --audit-primary: #1a252f;
      --audit-accent: #2980b9;
      --audit-bg: #ecf0f3;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei UI", "Microsoft YaHei", "Helvetica Neue", Helvetica, Arial, sans-serif;
      background-color: var(--audit-bg);
      height: 100vh;
      overflow: hidden;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      color: #2c3e50;
    }

    .app-auth-wrapper {
      height: 100vh;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    }

    /* 左侧登录区 */
    .auth-main-col {
      background: #ffffff;
      position: relative;
      z-index: 10;
      box-shadow: 10px 0 30px rgba(0, 0, 0, 0.03);
    }

    /* =========================================
       [修改] 右侧背景区容器 - 使用本地图片
       =========================================
    */
    .auth-background-col {
      position: relative;
      /* 这里使用了相对路径，对应 src/main/resources/static/assets/images/background/background-JF.jpg */
      background: url('assets/images/background/background-JF.jpg') no-repeat center center;
      background-size: cover;
      overflow: hidden;
    }

    /* 增加一个半透明遮罩，让图片看起来不那么刺眼，更专业 */
    .auth-background-col::before {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(30, 42, 56, 0.4); /* 深蓝色遮罩 */
      z-index: 1;
    }

    /* 登录框容器 */
    .app-auth-body {
      width: 100%;
      max-width: 440px;
      padding: 3rem;
    }

    .auth-heading {
      font-family: -apple-system, "Microsoft YaHei UI", "Microsoft YaHei", sans-serif;
      font-weight: 800;
      color: var(--audit-primary);
      letter-spacing: 1.5px;
      font-size: 1.8rem;
      margin-bottom: 0.5rem !important;
      text-transform: uppercase;
    }

    .sub-heading {
      font-size: 0.9rem;
      color: #7f8c8d;
      letter-spacing: 0.5px;
      font-weight: 500;
      margin-bottom: 2rem;
    }

    .app-logo img {
      height: 60px;
      margin-bottom: 1rem;
    }

    /* 输入框美化 */
    .form-control {
      height: 54px;
      border: 2px solid #eaeff2;
      background-color: #fcfdfe;
      border-radius: 6px;
      padding-left: 20px;
      font-size: 1rem;
      font-weight: 500;
      color: #2c3e50;
      transition: all 0.2s ease-in-out;
    }

    .form-control::placeholder {
      color: #bdc3c7;
      font-weight: 400;
      font-size: 0.95rem;
    }

    .form-control:focus {
      background-color: #fff;
      border-color: var(--audit-accent);
      box-shadow: 0 0 0 4px rgba(41, 128, 185, 0.1);
      color: #000;
    }

    .form-floating>label {
      padding-left: 20px;
      padding-top: 1.1rem;
      color: #95a5a6;
    }

    .form-floating>.form-control:focus~label,
    .form-floating>.form-control:not(:placeholder-shown)~label {
      transform: scale(0.85) translateY(-0.7rem) translateX(0.15rem);
      color: var(--audit-accent);
      font-weight: 600;
    }

    /* 按钮美化 */
    .btn.app-btn-primary {
      background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
      color: white;
      height: 54px;
      font-weight: 700;
      border: none;
      border-radius: 6px;
      letter-spacing: 2px;
      font-size: 1.05rem;
      transition: all 0.3s;
      box-shadow: 0 4px 6px rgba(44, 62, 80, 0.1);
    }

    .btn.app-btn-primary:hover {
      background: linear-gradient(135deg, #1a252f 0%, #2c3e50 100%);
      transform: translateY(-1px);
      box-shadow: 0 6px 12px rgba(44, 62, 80, 0.2);
    }

    .btn.app-btn-primary:disabled {
      background: #95a5a6;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    a.text-link,
    a.text-decoration-none {
      color: var(--audit-accent);
      font-weight: 600;
      font-size: 0.9rem;
    }

    a.text-link:hover,
    a.text-decoration-none:hover {
      color: #1a5276;
      text-decoration: underline !important;
    }

    .loading-overlay {
      position: absolute;
      top: -1rem;
      left: -1rem;
      right: -1rem;
      bottom: -1rem;
      background: rgba(255, 255, 255, 0.92);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 100;
      border-radius: 12px;
      backdrop-filter: blur(2px);
      display: none;
    }

    #debug-area-styled {
      background-color: #1e1e1e;
      border: 1px solid #333;
      color: #4ec9b0;
      font-family: "Cascadia Code", "Fira Code", "Consolas", "Courier New", monospace;
      border-radius: 4px;
      padding: 1rem;
      margin-top: 2rem;
      max-height: 200px;
      overflow-y: auto;
      font-size: 0.8rem;
      line-height: 1.4;
    }

    .form-check-input {
      cursor: pointer;
      border: 2px solid #bdc3c7;
    }

    .form-check-input:checked {
      background-color: var(--audit-accent);
      border-color: var(--audit-accent);
    }

    .form-check-label {
      user-select: none;
      cursor: pointer;
    }

    .password-toggle {
      position: absolute;
      top: 50%;
      right: 15px;
      transform: translateY(-50%);
      cursor: pointer;
      z-index: 10;
      color: #95a5a6;
      transition: all 0.3s ease;
      padding: 5px;
    }

    .password-toggle:hover {
      color: var(--audit-accent);
    }

    .form-floating>label {
      z-index: 5;
    }

    .action-item {
      display: inline-flex;
      align-items: center;
      height: 32px;
      padding: 0 12px;
      font-size: 12px;
      line-height: 1;
      color: #6c757d;
      text-decoration: none;
      border-radius: 6px;
      cursor: pointer;
      user-select: none;
    }

    .action-item:hover {
      background-color: #f1f3f5;
      color: #495057;
    }

    .action-checkbox {
      position: absolute;
      opacity: 0;
      pointer-events: none;
    }

    .checkbox-ui {
      width: 14px;
      height: 14px;
      border: 1.5px solid #adb5bd;
      border-radius: 3px;
      margin-right: 6px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      box-sizing: border-box;
    }

    .action-checkbox:checked+.checkbox-ui {
      background-color: #0d6efd;
      border-color: #0d6efd;
    }

    .action-checkbox:checked+.checkbox-ui::after {
      content: "";
      width: 6px;
      height: 3px;
      border-left: 2px solid #fff;
      border-bottom: 2px solid #fff;
      transform: rotate(-45deg);
    }

    .action-text {
      white-space: nowrap;
    }

    @media (max-width: 991px) {
      .auth-background-col {
        display: none;
      }

      .auth-main-col {
        width: 100%;
        max-width: 100%;
        padding: 0;
      }

      .app-auth-body {
        max-width: 100%;
        padding: 2rem;
      }
    }
  </style>
</head>

<body class="app app-login p-0">
  <div class="toast-container position-fixed top-0 start-50 translate-middle-x p-3">
    <div id="login-toast" class="toast shadow-lg border-0" role="alert" aria-live="assertive" aria-atomic="true"
      data-bs-delay="4000">
      <div class="toast-header border-bottom-0 text-white" style="background: #2c3e50;">
        <i class="fas fa-shield-alt me-2"></i>
        <strong class="me-auto" id="toast-header-title"
          style="font-family: 'Microsoft YaHei UI', sans-serif;">系统提示</strong>
        <small id="toast-time" class="text-white-50">刚刚</small>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
      <div class="toast-body fw-bold d-flex align-items-center bg-white" id="toast-body-content"
        style="min-height: 60px; font-size: 1rem; color: #333;">
      </div>
    </div>
  </div>

  <div class="row g-0 app-auth-wrapper">
    <div class="col-12 col-lg-4 auth-main-col text-center d-flex justify-content-center align-items-center">

      <div class="app-auth-body mx-auto position-relative text-start">

        <div id="form-loading" class="loading-overlay">
          <div class="d-flex flex-column align-items-center">
            <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem; border-width: 3px;"
              role="status"></div>
            <span style="font-family: 'Microsoft YaHei UI'; font-weight: 600; color: #555;">正在验证身份权限...</span>
          </div>
        </div>

        <div class="text-center">
          <a class="app-logo d-inline-block" href="#">
            <img class="logo-icon" src="assets/images/app-logo.svg" alt="Logo"
              onerror="this.outerHTML='<i class=\'fas fa-user-shield fa-3x\' style=\'color:#2c3e50\'></i>'" />
          </a>
          <h2 class="auth-heading mt-3">审查系统入口</h2>
          <p class="sub-heading">SECURE AUDIT & CONTROL SYSTEM</p>
        </div>

        <div class="auth-form-container">
          <form class="auth-form login-form" id="login-form">
            <div class="form-floating mb-3">
              <input id="username" name="username" type="text" class="form-control" placeholder="" required="required"
                autocomplete="username">
              <label for="username"><i class="fas fa-user me-2"></i>工号</label>
            </div>

            <div class="password-group mb-4">
              <div class="form-floating position-relative">
                <input id="password" name="password" type="password" class="form-control" placeholder=""
                  required="required" autocomplete="current-password" style="padding-right: 50px;">
                <label for="password"><i class="fas fa-key me-2"></i>密码</label>

                <span class="password-toggle" onclick="togglePasswordVisibility()" title="">
                  <i class="fas fa-eye-slash" id="password-icon"></i>
                </span>
              </div>

              <div class="extra mt-3 d-flex justify-content-between">
                <label class="action-item">
                  <input type="checkbox" id="RememberPassword" name="remember" class="action-checkbox" />
                  <span class="checkbox-ui"></span>
                  <span class="action-text">记住账号密码</span>
                </label>

                <a href="/signup" class="action-item">
                  注册账号
                </a>
              </div>
            </div>

            <div class="d-grid gap-2 mt-4">
              <button type="submit" class="btn app-btn-primary theme-btn" id="submit-btn">
                安全登录
              </button>
            </div>
          </form>

          <div id="debug-area-styled" style="display: none;">
            <div class="mb-2" style="color:#f44336; font-weight:bold;">
              <i class="fas fa-exclamation-triangle me-2"></i>SYSTEM_EXCEPTION
            </div>
            <div id="debug-area">
              <span id="debug-msg"></span>
            </div>
          </div>

        </div>

        <div class="auth-option text-center pt-5 text-muted" style="font-size: 0.8rem;">
          &copy; 2025 内部审查系统 | 仅限授权访问 <br>
          IP: 127.0.0.1 (Local)
        </div>
      </div>
    </div>

    <div class="col-12 col-lg-8 h-100 auth-background-col">
    </div>
  </div>

  <script src="/material/axios.min.js"></script>
  <script src="assets/plugins/bootstrap/js/bootstrap.bundle.min.js"></script>

  <script>
    // 逻辑保留：本地存储回显
    document.addEventListener("DOMContentLoaded", function () {
      // [已移除] Vanta 初始化代码

      const savedUser = localStorage.getItem('audit_saved_user');
      const savedPass = localStorage.getItem('audit_saved_pass');
      const savedCheck = localStorage.getItem('audit_remember_check');

      if (savedCheck === 'true' && savedUser) {
        document.getElementById('username').value = savedUser;
        if (savedPass) {
          try {
            document.getElementById('password').value = atob(savedPass);
          } catch (e) { console.error('密码解析失败'); }
        }
        document.getElementById('RememberPassword').checked = true;
      }
    });
  </script>

  <script>
    // DOM 元素引用
    const loginForm = document.getElementById('login-form');
    const submitBtn = document.getElementById('submit-btn');
    const debugArea = document.getElementById('debug-area');
    const debugMsg = document.getElementById('debug-msg');
    const loadingOverlay = document.getElementById('form-loading');

    // 初始化 Toast
    const toastEl = document.getElementById('login-toast');
    const toastInstance = new bootstrap.Toast(toastEl);
    const toastTitle = document.getElementById('toast-header-title');
    const toastBody = document.getElementById('toast-body-content');

    /**
     * 显示 Toast 提示
     */
    function showToast(type, title, message) {
      toastEl.className = `toast shadow-lg border-0 ${type === 'success' ? 'bg-success' : 'bg-danger'}`;
      toastEl.querySelector('.toast-header').className = `toast-header border-bottom-0 text-white ${type === 'success' ? 'bg-success' : 'bg-danger'}`;
      toastTitle.textContent = title;
      toastBody.innerHTML = message;
      toastInstance.show();
    }

    /**
     * 显示调试信息
     */
    function showDebugInfo(error) {
      document.getElementById('debug-area-styled').style.display = 'block';
      debugArea.style.display = 'block';
      let msg = new Date().toLocaleString() + ' - ';
      if (error.response) {
        msg += `Status: ${error.response.status} | Data: ${JSON.stringify(error.response.data)}`;
      } else if (error.request) {
        msg += `Network Error: 无响应 (请检查网络或服务器IP)`;
      } else {
        msg += `Error: ${error.message}`;
      }
      debugMsg.textContent = msg;
    }

    axios.defaults.timeout = 8000;

    async function attemptLogin(params, retries = 1) {
      try {
        const response = await axios.post('/api/users/login', params);
        return response;
      } catch (error) {
        if (retries > 0 && (!error.response || error.response.status >= 500)) {
          console.warn(`请求失败，正在重试... 剩余次数: ${retries}`);
          showToast('error', '网络波动', `连接不稳定，正在自动重试 (${retries})...`);
          await new Promise(r => setTimeout(r, 1000));
          return attemptLogin(params, retries - 1);
        } else {
          throw error;
        }
      }
    }

    loginForm.addEventListener('submit', function (e) {
      e.preventDefault();

      const username = document.getElementById('username').value.trim();
      const password = document.getElementById('password').value.trim();

      if (!username || !password) {
        showToast('error', '提示', '请填写完整的账号和密码');
        return;
      }

      submitBtn.disabled = true;
      submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span> 安全验证中...';
      loadingOverlay.style.display = 'flex';
      document.getElementById('debug-area-styled').style.display = 'none';

      const params = new URLSearchParams();
      params.append('username', username);
      params.append('password', password);

      attemptLogin(params)
        .then(function (response) {
          if (response.data && response.data.success) {

            const isRemember = document.getElementById('RememberPassword').checked;
            if (isRemember) {
              localStorage.setItem('audit_remember_check', 'true');
              localStorage.setItem('audit_saved_user', username);
              localStorage.setItem('audit_saved_pass', btoa(password));
            } else {
              localStorage.removeItem('audit_remember_check');
              localStorage.removeItem('audit_saved_user');
              localStorage.removeItem('audit_saved_pass');
            }
            const userRole = response.data.role;
            if (userRole) sessionStorage.setItem('userRole', userRole);

            let roleName = '用户';
            if (userRole === 'manager') roleName = '管理员';
            if (userRole === 'designer') roleName = '设计员';
            if (userRole === 'student') roleName = '学生';

            showToast('success', '验证通过', `身份确认：<b>${roleName}</b>。正在进入系统...`);

            setTimeout(() => {
              window.location.href = response.data.redirectUrl || '/index';
            }, 1500);
          } else {
            throw new Error(response.data.message || '未知业务错误');
          }
        })
        .catch(function (error) {
          console.error(error);
          let userMsg = '登录遇到问题，请重试';

          if (error.response) {
            if (error.response.status === 401 || error.response.data?.message) {
              userMsg = error.response.data.message || '用户名或密码错误';
            } else if (error.response.status === 404) {
              userMsg = '登录接口不存在 (404)，请联系管理员';
            } else if (error.response.status >= 500) {
              userMsg = '服务器内部错误 (500)，请稍后再试';
            }
          } else if (error.request) {
            userMsg = '无法连接到服务器，请检查网络或防火墙设置';
          } else {
            userMsg = error.message;
          }

          showToast('error', '登录失败', userMsg);

          showDebugInfo(error);

          submitBtn.disabled = false;
          submitBtn.innerHTML = '安全登录';
          loadingOverlay.style.display = 'none';
        });
    });

    function togglePasswordVisibility() {
      const passwordInput = document.getElementById('password');
      const passwordIcon = document.getElementById('password-icon');

      if (passwordInput.type === 'password') {
        // 切换为可见
        passwordInput.type = 'text';
        passwordIcon.classList.remove('fa-eye-slash');
        passwordIcon.classList.add('fa-eye');
        passwordIcon.style.color = '#3498db'; // 高亮提示当前是明文状态
      } else {
        // 切换为隐藏
        passwordInput.type = 'password';
        passwordIcon.classList.remove('fa-eye');
        passwordIcon.classList.add('fa-eye-slash');
        passwordIcon.style.color = ''; // 恢复默认颜色
      }
    }

  </script>
</body>

</html>