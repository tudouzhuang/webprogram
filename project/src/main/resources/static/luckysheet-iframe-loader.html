<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <title>Luckysheet Iframe Loader</title>
    <link rel='stylesheet' href='/luckysheet/plugins/css/pluginsCss.css' />
    <link rel='stylesheet' href='/luckysheet/plugins/plugins.css' />
    <link rel='stylesheet' href='/luckysheet/css/luckysheet.css' />
    <link rel='stylesheet' href='/luckysheet/assets/iconfont/iconfont.css' />
    <style>
        html,
        body,
        #luckysheet-container {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        .loader {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            font-size: 1.1em;
            color: #888;
            text-align: center;
            padding: 10px;
        }
    </style>
</head>

<body>
    <div id="luckysheet-container">
        <div class="loader">ç­‰å¾…çˆ¶çª—å£æŒ‡ä»¤...</div>
    </div>

    <script src="/luckysheet/plugins/js/plugin.js"></script>
    <script src="/luckysheet/luckysheet.umd.js"></script>
    <script src="/luckysheet/luckyexcel.umd.js"></script>
    <script src="/js/libs/exceljs.min.js"></script>

    <script type="module">
        // --- [1. å¯¼å…¥å¤–éƒ¨æ¨¡å—] ---
        import { exportWithExcelJS } from '/js/utils/luckysheetExporter.js';

        // --- [2. å…¨å±€å˜é‡ä¸çŠ¶æ€] ---
        const container = document.getElementById('luckysheet-container');
        let originalDataValidation = {};
        let originalRowlen = {};
        
        // --- [3. è¾…åŠ©å‡½æ•°å®šä¹‰] ---
        function restoreRowHeight(startRow, rowCount) {
            // ç¡®ä¿ luckysheet å®ä¾‹å­˜åœ¨
            if (!window.luckysheet) return;

            for (let i = 0; i < rowCount; i++) {
                const rowIndex = String(startRow + i);
                const originalHeight = originalRowlen[rowIndex];

                if (originalHeight !== undefined) {
                    const currentHeight = luckysheet.getRowHeight([parseInt(rowIndex)])[rowIndex];

                    if (currentHeight !== originalHeight) {
                        console.log(`[Row Height Fix] æ£€æµ‹åˆ°è¡Œ ${parseInt(rowIndex) + 1} é«˜åº¦è¢«è‡ªåŠ¨ä¿®æ”¹ï¼Œæ­£åœ¨ä» ${currentHeight} æ¢å¤è‡³ ${originalHeight}`);
                        luckysheet.setRowHeight({ [rowIndex]: originalHeight });
                    }
                }
            }
        }
        
        /**
         * Debounce é˜²æŠ–å‡½æ•°
         */
        function debounce(func, wait) {
            let timeout;
            return function (...args) {
                const context = this;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), wait);
            };
        }

        /**
         * æ ¸å¿ƒç»Ÿè®¡ä¸æ±‡æŠ¥å‡½æ•°
         */
        function calculateAndReportStats() {
            if (!window.luckysheet) return; // å®‰å…¨æ£€æŸ¥
            console.log('[Iframe] å˜æ›´å·²è§¦å‘ï¼Œå‡†å¤‡æ‰§è¡Œç»Ÿè®¡...');

            const rules = [
                { category: 'å†…å®¡è‡ªæ£€', range: 'G10:G50', ok: 'âˆš', ng: 'Ã—', na: 'æ— ' },
                { category: 'FMCè‡ªæ£€', range: 'H10:H50', ok: 'âˆš', ng: 'Ã—', na: 'æ— ' }
            ];
            const statsResult = {};

            rules.forEach(rule => {
                try {
                    const rangeData = luckysheet.getRangeArray(rule.range);
                    let okCount = 0, ngCount = 0, naCount = 0;

                    rangeData.forEach(row => {
                        row.forEach(cellValue => {
                            if (cellValue) {
                                if (cellValue === rule.ok) okCount++;
                                else if (cellValue === rule.ng) ngCount++;
                                else if (cellValue === rule.na) naCount++;
                            }
                        });
                    });

                    const totalCount = okCount + ngCount + naCount;
                    const okPercentage = totalCount > 0 ? Math.round((okCount / totalCount) * 10000) / 100 : 0;

                    statsResult[rule.category] = {
                        category: rule.category, okCount, ngCount, naCount, totalCount, okPercentage
                    };
                } catch (e) {
                    console.error(`[Iframe] ç»Ÿè®¡è§„åˆ™ "${rule.category}" æ‰§è¡Œå¤±è´¥:`, e);
                }
            });

            console.log('[Iframe] ç»Ÿè®¡è®¡ç®—å®Œæˆï¼Œç»“æœ:', statsResult);

            window.parent.postMessage({
                type: 'STATS_UPDATE',
                payload: statsResult
            }, window.location.origin);
        }

        /**
         * è‡ªåŠ¨æ ‡çº¢å‡½æ•°
         */
        function autoHighlightCell(r, c, cell) {
            if (!window.luckysheet || !cell) return;

            const cellValue = cell.v ? String(cell.v).trim() : '';
            const targetColumns = [4, 5, 6, 7, 8, 9, 10]; // E=4, F=5, ..., K=10

            if (targetColumns.includes(c)) {
                if (cellValue === 'Ã—') {
                    luckysheet.setCellFormat(r, c, 'bg', '#ffdddd');
                    luckysheet.setCellFormat(r, c, 'fc', '#9c0006');
                } else {
                    if (cell.bg === '#ffdddd') {
                        luckysheet.setCellFormat(r, c, 'bg', null);
                        luckysheet.setCellFormat(r, c, 'fc', null);
                    }
                }
            }
        }

        /**
         * åˆ›å»ºé˜²æŠ–å‡½æ•°çš„å®ä¾‹
         */
        const debouncedCalculate = debounce(calculateAndReportStats, 500);

        // --- [4. æ ¸å¿ƒåŠŸèƒ½å‡½æ•°] ---

/**
         * æ¸²æŸ“ Luckysheet å®ä¾‹ (API å…¼å®¹æ€§ä¿®å¤ç‰ˆ)
         */
         function renderSheet(luckysheetData, fileName, options) {
            console.group("ã€Iframe Debugã€‘å¼€å§‹æ¸²æŸ“æµç¨‹");
            
            // æ­¥éª¤ 1: é”€æ¯æ—§å®ä¾‹
            if (window.luckysheet) {
                try {
                    luckysheet.destroy();
                } catch (e) { console.warn("é”€æ¯æ—§å®ä¾‹å‡ºé”™:", e); }
            }
            container.innerHTML = '';

            // --- [é˜¶æ®µ A: æ•°æ®æ¸…æ´—] ---
            let validData = luckysheetData;
            
            // åŸºç¡€æ ¡éªŒ
            if (!Array.isArray(validData) || validData.length === 0) {
                console.warn("âš ï¸ æ•°æ®ä¸ºç©ºï¼Œåˆå§‹åŒ–é»˜è®¤é¡µ");
                validData = [{ name: "Sheet1", status: 1, order: 0, celldata: [], config: {} }];
            } else {
                try { validData = JSON.parse(JSON.stringify(validData)); } catch(e) {}
            }

            // ç¡®ä¿æ¿€æ´»çŠ¶æ€
            let hasActive = false;
            validData.forEach((sheet) => {
                if (!sheet.celldata) sheet.celldata = [];
                if (!sheet.config) sheet.config = {};
                if (sheet.status === 1) hasActive = true;
            });

            if (!hasActive) {
                console.warn("âš ï¸ å¼ºåˆ¶æ¿€æ´»ç¬¬ 0 ä¸ª Sheet");
                validData[0].status = 1;
            }

            // æ­¥éª¤ 2: å¤‡ä»½é…ç½®
            originalDataValidation = {};
            if (validData[0] && validData[0].config && validData[0].config.rowlen) {
                originalRowlen = { ...validData[0].config.rowlen };
            } else {
                originalRowlen = {};
            }

            // æ­¥éª¤ 3: åˆ›å»ºå®ä¾‹
            const finalOptions = {
                container: 'luckysheet-container',
                data: validData,
                title: fileName,
                lang: 'zh',
                ...options
            };

            try {
                luckysheet.create(finalOptions);
                console.log("âœ… luckysheet.create æ‰§è¡Œå®Œæ¯•");
            } catch (createError) {
                console.error("ğŸ”¥ Create å¤±è´¥:", createError);
                return;
            }

            // æ­¥éª¤ 4: å®‰å…¨çš„åç»­å¤„ç† (ç§»é™¤ getFlowdata ä¾èµ–)
            setTimeout(() => {
                console.group("ã€Iframe Debugã€‘é…ç½®ä¸é’©å­è®¾ç½®");
                try {
                    // 1. è®¾ç½®é…ç½®
                    if (luckysheet) {
                        luckysheet.luckysheetautofixrowlen = false;
                        console.log("é…ç½® luckysheetautofixrowlen = false");
                    }

                    // 2. å°è¯• Refresh (ç›´æ¥ç”¨ try-catch åŒ…è£¹ï¼Œä¸ä¾èµ– API æ£€æŸ¥)
                    // å¦‚æœ luckysheet å†…éƒ¨æ²¡å‡†å¤‡å¥½ï¼Œè¿™é‡Œä¼šæŠ¥é”™ï¼Œä½†è¢«æˆ‘ä»¬æ‹¦æˆªï¼Œä¸ä¼šå½±å“ç•Œé¢
                    try {
                        console.log("å°è¯•æ‰§è¡Œ refresh()...");
                        luckysheet.refresh();
                        console.log("âœ… refresh() æ‰§è¡ŒæˆåŠŸ");
                    } catch (refreshErr) {
                        console.warn("âš ï¸ refresh() æœªæ‰§è¡Œ (è¿™é€šå¸¸ä¸å½±å“ä½¿ç”¨):", refreshErr.message);
                    }

                    // --- [å…³é”®ä¿®å¤] é‡å†™ Hooks ---
                    // ä¸å†ä½¿ç”¨ luckysheet.getFlowdata()
                    if (window.luckysheet && !window.luckysheet.hooks) {
                        window.luckysheet.hooks = {};
                    }
                    window.luckysheet.hooks.cellUpdated = function (r, c, r_len, c_len) {
                        try {
                            // æ›¿ä»£æ–¹æ¡ˆï¼šé€šè¿‡ getAllSheets æŸ¥æ‰¾å½“å‰æ¿€æ´»çš„ sheet
                            const allSheets = luckysheet.getAllSheets();
                            // æ‰¾åˆ° status ä¸º 1 çš„ sheetï¼Œæ‰¾ä¸åˆ°å°±ç”¨ç¬¬ 0 ä¸ª
                            const currentSheet = allSheets.find(s => s.status === 1) || allSheets[0];
                            
                            // é˜²å¾¡æ€§è·å–å•å…ƒæ ¼æ•°æ®
                            if (currentSheet && currentSheet.data && currentSheet.data[r] && currentSheet.data[r][c]) {
                                const cell = currentSheet.data[r][c];
                                autoHighlightCell(r, c, cell);
                                debouncedCalculate();
                            }
                        } catch(hookError) {
                            console.error("Hook å†…éƒ¨é”™è¯¯ (å·²æ‹¦æˆª):", hookError);
                        }
                    };
                    console.log("Hooks è®¾ç½®å®Œæˆ (å·²ç§»é™¤ getFlowdata ä¾èµ–)");

                } catch (e) {
                    console.error("ğŸ”¥ é…ç½®é˜¶æ®µä¸¥é‡é”™è¯¯:", e);
                }
                console.groupEnd();
            }, 300); // å»¶è¿Ÿ 300ms
            
            console.groupEnd();
        }

        /**
         * ä»æ–‡ä»¶URLåŠ è½½æ•°æ®
         */
        function loadSheetFromFile(fileUrl, fileName, options) {
            container.innerHTML = `<div class="loader">æ­£åœ¨åŠ è½½æ•°æ®...</div>`;

            fetch(fileUrl)
                .then(response => {
                    if (!response.ok) throw new Error(`ç½‘ç»œé”™è¯¯: ${response.statusText}`);
                    const clonedResponse = response.clone();

                    return response.json()
                        .then(jsonData => {
                            console.log("[Iframe] âœ… æˆåŠŸå°†å“åº”è§£æä¸ºJSONï¼");
                            // JSON å¯èƒ½æ˜¯ç›´æ¥çš„ sheets æ•°ç»„ï¼Œä¹Ÿå¯èƒ½æ˜¯åŒ…å« sheets çš„å¯¹è±¡
                            let dataToRender = Array.isArray(jsonData) ? jsonData : (jsonData.sheets || []);
                            renderSheet(dataToRender, fileName, options);
                        })
                        .catch(jsonError => {
                            console.warn("[Iframe] âš ï¸ è§£æä¸ºJSONå¤±è´¥ï¼Œå›é€€åˆ°äºŒè¿›åˆ¶æ–‡ä»¶å¤„ç†æ¨¡å¼ã€‚");
                            container.innerHTML = `<div class="loader">æ­£åœ¨ä½¿ç”¨å¤‡ç”¨æ¨¡å¼è§£ææ–‡ä»¶...</div>`;

                            return clonedResponse.blob().then(fileBlob => {
                                LuckyExcel.transformExcelToLucky(fileBlob,
                                    exportJson => {
                                        console.log("[Iframe] âœ… LuckyExcel è§£æäºŒè¿›åˆ¶æ–‡ä»¶æˆåŠŸï¼");
                                        // ã€ä¿®å¤ 3ã€‘ï¼šLuckyExcel è¿”å›çš„ exportJson.sheets å¯èƒ½æ˜¯ undefined
                                        const sheets = exportJson.sheets || [];
                                        const name = (exportJson.info && exportJson.info.name) || fileName;
                                        renderSheet(sheets, name, options);
                                    },
                                    excelError => {
                                        console.error("[Iframe] âŒ LuckyExcel è§£æå¤±è´¥:", excelError);
                                        container.innerHTML = `<div class="loader">æ–‡ä»¶è§£æå¤±è´¥ã€‚</div>`;
                                    }
                                );
                            });
                        });
                })
                .catch(error => {
                    console.error("[Iframe] âŒ åŠ è½½æ–‡ä»¶å¤±è´¥:", error);
                    container.innerHTML = `<div class="loader">æ–‡ä»¶åŠ è½½å¤±è´¥ã€‚</div>`;
                });
        }

        /**
         * å°†å®æ—¶è·å–çš„ sheet æ•°æ®ä¸åˆå§‹åŠ è½½çš„æ•°æ®éªŒè¯è§„åˆ™èåˆã€‚
         */
        function mergeDataWithValidation(liveSheets, validationRules) {
            return liveSheets.map(liveSheet => {
                if (liveSheet && liveSheet.order != null && validationRules[liveSheet.order]) {
                    if (!liveSheet.dataVerification || Object.keys(liveSheet.dataVerification).length === 0) {
                        liveSheet.dataVerification = validationRules[liveSheet.order];
                    }
                }
                return liveSheet;
            });
        }

        /**
         * è§¦å‘æ–‡ä»¶ä¸‹è½½ã€‚
         */
        function downloadBlob(blob, fileName) {
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.href = url;
            link.download = fileName;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        /**
         * å¤„ç†â€œä¸€é”®å¯¼å‡ºâ€çš„å‡½æ•°ã€‚
         */
        async function handleExport(fileName) {
            console.log("[Iframe] å¼€å§‹å¤ç”¨ exportWithExcelJS çš„å¯¼å‡ºæµç¨‹...");
            const loaderDiv = document.createElement('div');
            loaderDiv.className = 'loader';
            loaderDiv.style.cssText = 'position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(255, 255, 255, 0.8); z-index: 10000;';
            loaderDiv.textContent = 'æ­£åœ¨ç”ŸæˆExcelæ–‡ä»¶ï¼Œè¯·ç¨å€™...';
            container.appendChild(loaderDiv);

            try {
                const allSheetsData = luckysheet.getAllSheets();
                const blob = await exportWithExcelJS(allSheetsData);
                downloadBlob(blob, fileName);
                console.log("[Iframe] é€šè¿‡å¤ç”¨æ¨¡å—ï¼ŒæˆåŠŸå¯¼å‡ºæ–‡ä»¶ï¼");
            } catch (error) {
                console.error("[Iframe] å¤ç”¨å¯¼å‡ºæ¨¡å—æ—¶å‡ºé”™:", error);
                alert("å¯¼å‡ºæ–‡ä»¶æ—¶å‘ç”Ÿé”™è¯¯ï¼Œè¯¦æƒ…è¯·æŸ¥çœ‹æ§åˆ¶å°ã€‚");
            } finally {
                container.removeChild(loaderDiv);
            }
        }

        // --- [5. äº‹ä»¶ç›‘å¬å™¨] ---

        window.addEventListener('message', function (event) {
            if (event.origin !== window.location.origin) return;
            const { type, payload } = event.data;
            console.log(`[Iframe] æ”¶åˆ°æ¶ˆæ¯: type=${type}`, payload);

            if (type === 'LOAD_SHEET') {
                if (payload.luckysheetData) {
                    renderSheet(payload.luckysheetData, payload.fileName, payload.options);
                } else {
                    loadSheetFromFile(payload.fileUrl, payload.fileName, payload.options);
                }
            } else if (type === 'GET_DATA_AND_IMAGES') {
                if (window.luckysheet) {
                    const liveSheets = luckysheet.getAllSheets();
                    const mergedSheets = mergeDataWithValidation(liveSheets, originalDataValidation);

                    console.log('ã€iframeã€‘å‡†å¤‡å°† SHEET_DATA_WITH_IMAGES_RESPONSE æ¶ˆæ¯å›å‘ç»™çˆ¶çª—å£ï¼');
                    window.parent.postMessage({
                        type: 'SHEET_DATA_WITH_IMAGES_RESPONSE',
                        payload: {
                            sheets: mergedSheets,
                            purpose: payload.purpose,
                            fileId: payload.fileId,
                            documentType: payload.documentType
                        }
                    }, window.location.origin);
                }
            } else if (type === 'EXPORT_SHEET') {
                if (window.luckysheet) {
                    handleExport(payload.fileName || 'å¯¼å‡ºæ–‡ä»¶.xlsx');
                }
            }
        });

        document.body.addEventListener('mousedown', () => {
            window.parent.postMessage({ type: 'IFRAME_CLICKED' }, window.location.origin);
        }, true);

        console.log('[Iframe] åŠ è½½å™¨å·²å°±ç»ªï¼Œç­‰å¾…æ¶ˆæ¯...');

    </script>
</body>

</html>