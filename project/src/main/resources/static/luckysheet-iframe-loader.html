<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <title>Luckysheet Iframe Loader</title>
    <link rel='stylesheet' href='/luckysheet/plugins/css/pluginsCss.css' />
    <link rel='stylesheet' href='/luckysheet/plugins/plugins.css' />
    <link rel='stylesheet' href='/luckysheet/css/luckysheet.css' />
    <link rel='stylesheet' href='/luckysheet/assets/iconfont/iconfont.css' />
    <style>
        html,
        body,
        #luckysheet-container {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        .loader {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            font-size: 1.1em;
            color: #888;
            text-align: center;
            padding: 10px;
        }
    </style>
</head>

<body>
    <div id="luckysheet-container">
        <div class="loader">ç­‰å¾…çˆ¶çª—å£æŒ‡ä»¤...</div>
    </div>

    <script src="/luckysheet/plugins/js/plugin.js"></script>
    <script src="/luckysheet/luckysheet.umd.js"></script>
    <script src="/luckysheet/luckyexcel.umd.js"></script>
    <script src="/js/libs/exceljs.min.js"></script>

    <script type="module">
        // --- [0. å…¨å±€å¼‚å¸¸ç†”æ–­ (å¢å¼ºç‰ˆ)] ---
        // æ•è· Promise ä¹Ÿå°±æ˜¯ Luckysheet å†…éƒ¨æŠ›å‡ºçš„è‡´å‘½å¼‚æ­¥é”™è¯¯
        window.addEventListener('unhandledrejection', function (event) {
            console.error("[Iframe] âš ï¸ æ•è·åˆ°æœªå¤„ç†çš„ Promise å¼‚å¸¸:", event.reason);

            const reason = event.reason || {};
            const message = (reason.message || reason.toString() || "").toLowerCase();
            const name = reason.name || "";

            // å®šä¹‰è‡´å‘½é”™è¯¯çš„ç‰¹å¾ï¼š
            // 1. å­—ä½“è§£æé”™è¯¯ (SyntaxError: FontFaceSet...)
            // 2. å†…éƒ¨è®¡ç®—å´©æºƒ (TypeError: Cannot read properties...) -> ä½ é‡åˆ°çš„è¿™ä¸ª
            if (
                name === 'SyntaxError' ||
                name === 'TypeError' ||
                message.includes('fontfaceset') ||
                message.includes('could not resolve') ||
                message.includes('cannot read properties') || // ğŸ‘ˆ é’ˆå¯¹æœ¬æ¬¡æŠ¥é”™
                message.includes('reading')                   // ğŸ‘ˆ é’ˆå¯¹æœ¬æ¬¡æŠ¥é”™
            ) {
                // ç«‹å³æ˜¾ç¤ºé”™è¯¯é¡µ
                const container = document.getElementById('luckysheet-container');
                if (container) {
                    let userFriendlyMsg = "æ¸²æŸ“å¼•æ“å†…éƒ¨é€»è¾‘å´©æºƒ";

                    if (message.includes('font')) {
                        userFriendlyMsg = "æµè§ˆå™¨æ— æ³•åº”ç”¨å­—ä½“è®¾ç½®";
                    } else if (message.includes('cannot read') || message.includes('reading')) {
                        userFriendlyMsg = "è¡¨æ ¼ç»“æ„è¿‡å¤æ‚æˆ–å«éæ³•åˆå¹¶å•å…ƒæ ¼ï¼Œè®¡ç®—å¤±è´¥";
                    }

                    container.innerHTML = `
                        <div style="display:flex;flex-direction:column;justify-content:center;align-items:center;height:100%;background:#fff2f0;color:#cf1322;padding:20px;text-align:center;">
                            <h3 style="margin-bottom:10px;font-size:18px;">âŒ æ–‡ä»¶è§£æå¼‚å¸¸</h3>
                            <p style="font-size:14px;color:#666;">${userFriendlyMsg}</p>
                            <p style="font-size:12px;color:#999;margin-top:5px;">Technical Info: ${message.slice(0, 50)}...</p>
                        </div>
                    `;
                }

                // é€šçŸ¥çˆ¶çª—å£åœæ­¢ Loading
                window.parent.postMessage({
                    type: 'LUCKYSHEET_RENDER_FINISHED',
                    status: 'error',
                    message: "æ¸²æŸ“å´©æºƒ: " + (reason.message || "æœªçŸ¥å†…éƒ¨é”™è¯¯")
                }, window.location.origin);
            }
        });
        // --- [1. å¯¼å…¥å¤–éƒ¨æ¨¡å—] ---
        import { exportWithExcelJS } from '/js/utils/luckysheetExporter.js';

        // --- [2. å…¨å±€å˜é‡ä¸çŠ¶æ€] ---
        const container = document.getElementById('luckysheet-container');
        let originalDataValidation = {};
        let originalRowlen = {};

        // --- [3. è¾…åŠ©å‡½æ•°å®šä¹‰] ---

        /**
         * æ¢å¤è¡Œé«˜å‡½æ•°
         */
        function restoreRowHeight(startRow, rowCount) {
            // ç¡®ä¿ luckysheet å®ä¾‹å­˜åœ¨
            if (!window.luckysheet) return;

            for (let i = 0; i < rowCount; i++) {
                const rowIndex = String(startRow + i);
                const originalHeight = originalRowlen[rowIndex];

                if (originalHeight !== undefined) {
                    const currentHeight = luckysheet.getRowHeight([parseInt(rowIndex)])[rowIndex];

                    if (currentHeight !== originalHeight) {
                        console.log(`[Row Height Fix] æ£€æµ‹åˆ°è¡Œ ${parseInt(rowIndex) + 1} é«˜åº¦è¢«è‡ªåŠ¨ä¿®æ”¹ï¼Œæ­£åœ¨ä» ${currentHeight} æ¢å¤è‡³ ${originalHeight}`);
                        luckysheet.setRowHeight({ [rowIndex]: originalHeight });
                    }
                }
            }
        }

        /**
         * Debounce é˜²æŠ–å‡½æ•°
         */
        function debounce(func, wait) {
            let timeout;
            return function (...args) {
                const context = this;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), wait);
            };
        }

        /**
         * æ ¸å¿ƒç»Ÿè®¡ä¸æ±‡æŠ¥å‡½æ•°
         */
        function calculateAndReportStats() {
            if (!window.luckysheet) return; // å®‰å…¨æ£€æŸ¥
            // console.log('[Iframe] å˜æ›´å·²è§¦å‘ï¼Œå‡†å¤‡æ‰§è¡Œç»Ÿè®¡...');

            const rules = [
                { category: 'å†…å®¡è‡ªæ£€', range: 'G10:G50', ok: 'âˆš', ng: 'Ã—', na: 'æ— ' },
                { category: 'FMCè‡ªæ£€', range: 'H10:H50', ok: 'âˆš', ng: 'Ã—', na: 'æ— ' }
            ];
            const statsResult = {};

            rules.forEach(rule => {
                try {
                    const rangeData = luckysheet.getRangeArray(rule.range);
                    let okCount = 0, ngCount = 0, naCount = 0;

                    rangeData.forEach(row => {
                        row.forEach(cellValue => {
                            if (cellValue) {
                                if (cellValue === rule.ok) okCount++;
                                else if (cellValue === rule.ng) ngCount++;
                                else if (cellValue === rule.na) naCount++;
                            }
                        });
                    });

                    const totalCount = okCount + ngCount + naCount;
                    const okPercentage = totalCount > 0 ? Math.round((okCount / totalCount) * 10000) / 100 : 0;

                    statsResult[rule.category] = {
                        category: rule.category, okCount, ngCount, naCount, totalCount, okPercentage
                    };
                } catch (e) {
                    console.error(`[Iframe] ç»Ÿè®¡è§„åˆ™ "${rule.category}" æ‰§è¡Œå¤±è´¥:`, e);
                }
            });

            // console.log('[Iframe] ç»Ÿè®¡è®¡ç®—å®Œæˆï¼Œç»“æœ:', statsResult);

            window.parent.postMessage({
                type: 'STATS_UPDATE',
                payload: statsResult
            }, window.location.origin);
        }

        /**
         * è‡ªåŠ¨æ ‡çº¢å‡½æ•°
         */
        function autoHighlightCell(r, c, cell) {
            // ã€æ¢å¤´ Aã€‘: ç¡®è®¤å‡½æ•°æ˜¯å¦è¢«è°ƒç”¨
            // console.log(`[Highlight-Debug] autoHighlightCell è¢«è°ƒç”¨ï¼åæ ‡: (r=${r}, c=${c})`);

            if (!window.luckysheet || !cell) {
                // console.log('[Highlight-Debug] Luckysheet å®ä¾‹æˆ– cell å¯¹è±¡ä¸ºç©ºï¼Œå·²ç»ˆæ­¢ã€‚');
                return;
            }

            const cellValue = cell.v ? String(cell.v).trim() : '';
            const targetColumns = [4, 5, 6, 7, 8, 9, 10]; // E=4, F=5, ..., K=10

            // ã€æ¢å¤´ Cã€‘: ç¡®è®¤åˆ—åæ ‡æ˜¯å¦åœ¨ç›®æ ‡èŒƒå›´å†…
            if (targetColumns.includes(c)) {
                if (cellValue === 'Ã—') {
                    // ã€æ¢å¤´ D-1ã€‘: ç¡®è®¤æ˜¯å¦åŒ¹é… "Ã—"
                    luckysheet.setCellFormat(r, c, 'bg', '#ffdddd');
                    luckysheet.setCellFormat(r, c, 'fc', '#9c0006');
                } else {
                    // ã€æ¢å¤´ D-2ã€‘: ç¡®è®¤æ˜¯å¦è¿›å…¥â€œæ¸…é™¤é¢œè‰²â€çš„é€»è¾‘
                    if (cell.bg === '#ffdddd') {
                        luckysheet.setCellFormat(r, c, 'bg', null);
                        luckysheet.setCellFormat(r, c, 'fc', null);
                    }
                }
            }
        }

        /**
         * åˆ›å»ºé˜²æŠ–å‡½æ•°çš„å®ä¾‹ï¼Œå»¶è¿Ÿ500msæ‰§è¡Œã€‚
         */
        const debouncedCalculate = debounce(calculateAndReportStats, 500);

        // --- [4. æ ¸å¿ƒåŠŸèƒ½å‡½æ•°] ---

        /**
         * æ¸²æŸ“ Luckysheet å®ä¾‹ (å®Œæ•´é€»è¾‘ + ä¿®å¤å´©æºƒ + ç§»é™¤ getFlowdata ä¾èµ–)
         */
        function renderSheet(luckysheetData, fileName, options) {
            // æ­¥éª¤ 1: é”€æ¯æ—§å®ä¾‹
            if (window.luckysheet) {
                try {
                    luckysheet.destroy();
                } catch (e) { console.warn("é”€æ¯æ—§å®ä¾‹å‡ºé”™:", e); }
            }
            container.innerHTML = '';

            // --- [æ•°æ®é˜²å¾¡æ€§å¤„ç†] ---
            let validData = luckysheetData;

            // 1. å¦‚æœæ•°æ®ä¸ºç©ºæˆ–éæ•°ç»„ï¼Œåˆå§‹åŒ–é»˜è®¤é¡µ
            if (!Array.isArray(validData) || validData.length === 0) {
                console.warn("[Iframe] æ•°æ®ä¸ºç©ºï¼Œåˆå§‹åŒ–ä¸ºé»˜è®¤ Sheet1ã€‚");
                validData = [{
                    name: "Sheet1",
                    status: 1,
                    order: 0,
                    celldata: [],
                    config: {}
                }];
            } else {
                // æ·±æ‹·è´ï¼Œé˜²æ­¢ä¿®æ”¹å½±å“åŸå§‹æ•°æ®
                try { validData = JSON.parse(JSON.stringify(validData)); } catch (e) { }
            }

            // 2. ç¡®ä¿å¿…ç„¶æœ‰ä¸€ä¸ªæ¿€æ´»çš„ Sheet (status: 1)
            let hasActive = false;
            validData.forEach((sheet) => {
                // è¡¥å…¨å¿…è¦å­—æ®µé˜²æ­¢æŠ¥é”™
                if (!sheet.celldata) sheet.celldata = [];
                if (!sheet.config) sheet.config = {};
                // åˆå§‹åŒ–ç¼©æ”¾æ¯”ä¾‹ (åŸºäºæ–‡æ¡£)
                if (sheet.zoomRatio == null) sheet.zoomRatio = 1;

                if (sheet.status === 1) hasActive = true;
            });

            if (!hasActive) {
                console.warn("[Iframe] å¼ºåˆ¶æ¿€æ´»ç¬¬ 0 ä¸ª Sheet");
                validData[0].status = 1;
            }

            // æ­¥éª¤ 2: å¤‡ä»½åŸå§‹æ•°æ®
            originalDataValidation = {};
            validData.forEach(sheet => {
                if (sheet && sheet.order != null && sheet.dataVerification) {
                    originalDataValidation[sheet.order] = sheet.dataVerification;
                }
            });

            // å¤‡ä»½åŸå§‹è¡Œé«˜
            if (validData[0] && validData[0].config && validData[0].config.rowlen) {
                originalRowlen = { ...validData[0].config.rowlen };
                console.log("[Iframe] åŸå§‹è¡Œé«˜å·²å¤‡ä»½:", originalRowlen);
            } else {
                originalRowlen = {};
            }

            // æ­¥éª¤ 3: ç»„è£…é…ç½®å¯¹è±¡
            const finalOptions = {
                container: 'luckysheet-container',
                data: validData,
                title: fileName,
                lang: 'zh',

                // --- ã€æ ¸å¿ƒä¿®å¤ã€‘å¼ºåˆ¶æŒ‡å®šé»˜è®¤å­—ä½“é…ç½®ï¼Œé˜²æ­¢ '12px default' æŠ¥é”™ ---
                defaultFontSize: 14,
                limitSheetNameLength: false, // å…è®¸é•¿æ–‡ä»¶å
                fontList: [
                    { "fontName": "å¾®è½¯é›…é»‘", "url": "" },
                    { "fontName": "Arial", "url": "" },
                    { "fontName": "Times New Roman", "url": "" }
                ],
                showinfobar: false,
                // -----------------------------------------------------------

                ...options
            };

            // æ­¥éª¤ 4: åˆ›å»ºå®ä¾‹
            try {
                console.log(`[Iframe] å‡†å¤‡åˆ›å»ºå®ä¾‹...`);
                luckysheet.create(finalOptions);
                console.log(`[Iframe] åˆ›å»ºå®ä¾‹æˆåŠŸï¼`);
            } catch (createError) {
                console.error("ğŸ”¥ åˆ›å»º Luckysheet å®ä¾‹å¤±è´¥:", createError);
                return;
            }

            // æ­¥éª¤ 5: å»¶è¿Ÿæ‰§è¡Œ Refresh å’Œ Hook (ä¿®å¤æ ¸å¿ƒ)
            setTimeout(() => {
                try {
                    // å…¨å±€é…ç½®
                    if (window.luckysheet) {
                        luckysheet.luckysheetautofixrowlen = false;
                        console.log("[Iframe] é…ç½® luckysheetautofixrowlen = falseã€‚");
                    }

                    // å°è¯• Refresh (ä¸ä¾èµ– getFlowdata æ£€æŸ¥ï¼Œç›´æ¥å°è¯•)
                    try {
                        luckysheet.refresh();
                        console.log("[Iframe] luckysheet.refresh() æ‰§è¡ŒæˆåŠŸã€‚");
                    } catch (refreshError) {
                        console.warn("[Iframe] refresh() æ‰§è¡Œå—é˜» (é€šå¸¸ä¸å½±å“æ˜¾ç¤º):", refreshError.message);
                    }

                    // --- è®¾ç½® Hooks (å®Œå…¨ç§»é™¤ getFlowdata ä¾èµ–) ---
                    if (window.luckysheet && !window.luckysheet.hooks) {
                        window.luckysheet.hooks = {};
                    }

                    window.luckysheet.hooks.cellUpdated = function (r, c, r_len, c_len) {
                        try {
                            // ä½¿ç”¨ getAllSheets æ›¿ä»£ getFlowdata ä»¥é¿å…æŠ¥é”™
                            const allSheets = luckysheet.getAllSheets();
                            // æŸ¥æ‰¾å½“å‰æ¿€æ´»çš„ sheet
                            const currentSheet = allSheets.find(s => s.status === 1) || allSheets[0];

                            // å®‰å…¨è·å–å•å…ƒæ ¼æ•°æ®
                            if (currentSheet && currentSheet.data && currentSheet.data[r] && currentSheet.data[r][c]) {
                                const cell = currentSheet.data[r][c];

                                // æ‰§è¡ŒåŸæ¥çš„ä¸šåŠ¡é€»è¾‘
                                autoHighlightCell(r, c, cell);
                                debouncedCalculate();
                            }
                        } catch (hookError) {
                            console.error("[Hook Error] å•å…ƒæ ¼æ›´æ–°å¤„ç†å‡ºé”™:", hookError);
                        }
                    };
                    console.log("[Iframe] Hooks è®¾ç½®å®Œæˆã€‚");

                } catch (e) {
                    console.error(`[Iframe] å»¶è¿Ÿé…ç½®é˜¶æ®µå¤±è´¥:`, e);
                }
            }, 300); // å¢åŠ å»¶è¿Ÿåˆ° 300ms ç¡®ä¿ç¨³å®š
        }

        /**
         * ä»æ–‡ä»¶URLåŠ è½½æ•°æ®
         */
        function loadSheetFromFile(fileUrl, fileName, options) {
            container.innerHTML = `<div class="loader">æ­£åœ¨åŠ è½½æ•°æ®...</div>`;

            fetch(fileUrl)
                .then(response => {
                    if (!response.ok) throw new Error(`ç½‘ç»œé”™è¯¯: ${response.statusText}`);
                    const clonedResponse = response.clone();

                    return response.json()
                        .then(jsonData => {
                            console.log("[Iframe] âœ… æˆåŠŸå°†å“åº”è§£æä¸ºJSONï¼");
                            // å…¼å®¹ç›´æ¥æ˜¯æ•°ç»„æˆ–å¯¹è±¡åŒ…å« sheets çš„æƒ…å†µ
                            const dataToRender = Array.isArray(jsonData) ? jsonData : (jsonData.sheets || []);
                            renderSheet(dataToRender, fileName, options);
                        })
                        // ... å‰é¢çš„ fetch(...).then(...).then(...) ä¿æŒä¸å˜

                        .catch(jsonError => {
                            console.warn("[Iframe] âš ï¸ è§£æä¸ºJSONå¤±è´¥ï¼Œå›é€€åˆ°äºŒè¿›åˆ¶æ–‡ä»¶å¤„ç†æ¨¡å¼ã€‚");
                            container.innerHTML = `<div class="loader">æ­£åœ¨ä½¿ç”¨å¤‡ç”¨æ¨¡å¼è§£ææ–‡ä»¶...</div>`;

                            // 1. è·å– Blob æ•°æ®
                            return clonedResponse.blob().then(fileBlob => {

                                // ğŸ”¥ğŸ”¥ğŸ”¥ã€æ’å…¥ä¾¦æ¢ä»£ç å¼€å§‹ã€‘ğŸ”¥ğŸ”¥ğŸ”¥
                                console.log("ğŸ” [ä¾¦æ¢] å‡†å¤‡äº¤ç»™ LuckyExcel çš„æ–‡ä»¶ä¿¡æ¯ï¼š");
                                console.log("   - å¤§å°:", fileBlob.size, "å­—èŠ‚");
                                console.log("   - ç±»å‹:", fileBlob.type);

                                // å¦‚æœæ–‡ä»¶å°äº 1KBï¼Œææœ‰å¯èƒ½ä¸æ˜¯ Excelï¼Œè€Œæ˜¯åç«¯æŠ¥é”™æ–‡æœ¬
                                if (fileBlob.size < 1000) {
                                    const reader = new FileReader();
                                    reader.onload = function () {
                                        console.error("ğŸ’€ [ä¾¦æ¢] æ–‡ä»¶å¤ªå°ï¼Œç–‘ä¼¼æŠ¥é”™æ–‡æœ¬ï¼Œå†…å®¹å¦‚ä¸‹:", this.result);
                                    }
                                    reader.readAsText(fileBlob);
                                }

                                // ğŸ”¥ğŸ”¥ğŸ”¥ã€æ’å…¥ä¾¦æ¢ä»£ç ç»“æŸã€‘ğŸ”¥ğŸ”¥ğŸ”¥
                                // 2. å®šä¹‰è¶…æ—¶ç«é€Ÿ Promise (1000ç§’)
                                const timeoutPromise = new Promise((_, reject) => {
                                    setTimeout(() => {
                                        reject(new Error('TIMEOUT'));
                                    }, 1000000);
                                });

                                // 3. å®šä¹‰è§£æ Promise (åŒ…è£¹ LuckyExcel)
                                const parsingPromise = new Promise((resolve, reject) => {
                                    try {
                                        LuckyExcel.transformExcelToLucky(fileBlob,
                                            function (exportJson, luckysheetfile) {

                                                // ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ [è°ƒè¯•æ¢é’ˆ START] ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥
                                                console.group("%cğŸ” [Import Debug] å¼€å§‹æ£€æŸ¥è¯»å–åˆ°çš„ Excel æ–‡ä»¶", "color: red; font-size: 14px; font-weight: bold;");

                                                if (exportJson.sheets && exportJson.sheets.length > 0) {
                                                    exportJson.sheets.forEach((sheet, index) => {
                                                        console.log(`ğŸ“„ Sheet [${index}] åç§°: ${sheet.name}`);

                                                        // æ£€æŸ¥ dataVerification å­—æ®µ
                                                        if (sheet.dataVerification) {
                                                            const rules = Object.keys(sheet.dataVerification);
                                                            if (rules.length > 0) {
                                                                console.log(`   âœ… å‘ç° ${rules.length} æ¡éªŒè¯è§„åˆ™:`, sheet.dataVerification);
                                                            } else {
                                                                console.warn(`   âš ï¸ dataVerification å¯¹è±¡å­˜åœ¨ï¼Œä½†æ˜¯æ˜¯ç©ºçš„ (Empty Object)`);
                                                            }
                                                        } else {
                                                            console.error(`   âŒ è¯¥ Sheet å®Œå…¨æ²¡æœ‰ dataVerification å­—æ®µï¼`);
                                                        }
                                                    });
                                                } else {
                                                    console.error("âŒ è§£æç»“æœä¸­æ²¡æœ‰æ‰¾åˆ° sheetsï¼");
                                                }
                                                console.groupEnd();
                                                // ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ [è°ƒè¯•æ¢é’ˆ END] ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥

                                                if (exportJson.sheets == null || exportJson.sheets.length == 0) {
                                                    reject(new Error('EMPTY_CONTENT'));
                                                } else {
                                                    resolve(exportJson);
                                                }
                                            },
                                            function (err) {
                                                console.error("LuckyExcel internal error:", err);
                                                reject(new Error('PARSE_ERROR'));
                                            }
                                        );
                                    } catch (e) {
                                        // æ•è·åŒæ­¥å´©æºƒ (å¦‚ INTERSECTCLIPRECT)
                                        console.error("LuckyExcel crash:", e);
                                        reject(new Error('CRASH'));
                                    }
                                });

                                // 4. ã€æ ¸å¿ƒã€‘ç«é€Ÿï¼šè§£æ vs è¶…æ—¶
                                return Promise.race([parsingPromise, timeoutPromise]);
                            })
                                .then(exportJson => {
                                    // --- ç«é€Ÿèƒœåˆ©ï¼šè§£ææˆåŠŸ ---
                                    console.log("[Iframe] âœ… LuckyExcel è§£æäºŒè¿›åˆ¶æ–‡ä»¶æˆåŠŸï¼");
                                    const sheets = exportJson.sheets || [];
                                    const name = (exportJson.info && exportJson.info.name) || fileName;
                                    renderSheet(sheets, name, options);
                                })
                                .catch(err => {
                                    // --- ç«é€Ÿå¤±è´¥ï¼šè¶…æ—¶æˆ–æŠ¥é”™ ---
                                    console.error("[Iframe] âŒ è§£ææœ€ç»ˆå¤±è´¥:", err);

                                    let displayMsg = "æ­¤è¡¨æ ¼æ ¼å¼æœ‰é—®é¢˜ï¼Œæ— æ³•è§£æ";
                                    let subMsg = "æ–‡ä»¶å¯èƒ½åŒ…å«ä¸æ”¯æŒçš„å›¾å½¢/å…¬å¼æˆ–å·²æŸå";

                                    if (err.message === 'TIMEOUT') {
                                        displayMsg = "æ–‡ä»¶è§£æè¶…æ—¶ (10ç§’)";
                                        subMsg = "æ–‡ä»¶è¿‡äºå¤æ‚ï¼Œè¯·å°è¯•ç®€åŒ–æ ¼å¼åæŸ¥çœ‹æˆ–è€…ä¸‹è½½";
                                    }

                                    // A. Iframe ç•Œé¢æ˜¾ç¤ºçº¢å±é”™è¯¯
                                    container.innerHTML = `
                            <div style="display:flex;flex-direction:column;justify-content:center;align-items:center;height:100%;background:#fff2f0;color:#cf1322;padding:20px;text-align:center;">
                                <h3 style="margin-bottom:10px;font-size:18px;">âŒ ${displayMsg}</h3>
                                <p style="font-size:14px;color:#666;">${subMsg}</p>
                            </div>
                        `;

                                    // B. é€šçŸ¥çˆ¶çª—å£ (Vue) åœæ­¢ Loading å¹¶æŠ¥é”™
                                    window.parent.postMessage({
                                        type: 'LUCKYSHEET_RENDER_FINISHED',
                                        status: 'error',
                                        message: displayMsg
                                    }, window.location.origin);
                                });
                        }); // fetch çš„ catch ç»“æŸ
                })
                .catch(error => {
                    console.error("[Iframe] âŒ åŠ è½½æ–‡ä»¶å¤±è´¥:", error);
                    container.innerHTML = `<div class="loader">æ–‡ä»¶åŠ è½½å¤±è´¥ã€‚</div>`;
                });
        }

        /**
         * èåˆéªŒè¯è§„åˆ™
         */
        function mergeDataWithValidation(liveSheets, validationRules) {
            return liveSheets.map(liveSheet => {
                if (liveSheet && liveSheet.order != null && validationRules[liveSheet.order]) {
                    if (!liveSheet.dataVerification || Object.keys(liveSheet.dataVerification).length === 0) {
                        liveSheet.dataVerification = validationRules[liveSheet.order];
                    }
                }
                return liveSheet;
            });
        }

        /**
         * è§¦å‘æ–‡ä»¶ä¸‹è½½
         */
        function downloadBlob(blob, fileName) {
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.href = url;
            link.download = fileName;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        /**
         * å¤„ç†å¯¼å‡º
         */
        async function handleExport(fileName) {
            console.log("[Iframe] å¼€å§‹å¤ç”¨ exportWithExcelJS çš„å¯¼å‡ºæµç¨‹...");
            const loaderDiv = document.createElement('div');
            loaderDiv.className = 'loader';
            loaderDiv.style.cssText = 'position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(255, 255, 255, 0.8); z-index: 10000;';
            loaderDiv.textContent = 'æ­£åœ¨ç”ŸæˆExcelæ–‡ä»¶ï¼Œè¯·ç¨å€™...';
            container.appendChild(loaderDiv);

            try {
                const allSheetsData = luckysheet.getAllSheets();
                const blob = await exportWithExcelJS(allSheetsData);
                downloadBlob(blob, fileName);
                console.log("[Iframe] é€šè¿‡å¤ç”¨æ¨¡å—ï¼ŒæˆåŠŸå¯¼å‡ºæ–‡ä»¶ï¼");
            } catch (error) {
                console.error("[Iframe] å¤ç”¨å¯¼å‡ºæ¨¡å—æ—¶å‡ºé”™:", error);
                alert("å¯¼å‡ºæ–‡ä»¶æ—¶å‘ç”Ÿé”™è¯¯ï¼Œè¯¦æƒ…è¯·æŸ¥çœ‹æ§åˆ¶å°ã€‚");
            } finally {
                container.removeChild(loaderDiv);
            }
        }

        // --- [5. äº‹ä»¶ç›‘å¬å™¨] ---

        window.addEventListener('message', function (event) {
            if (event.origin !== window.location.origin) return;
            const { type, payload } = event.data;
            // console.log(`[Iframe] æ”¶åˆ°æ¶ˆæ¯: type=${type}`, payload);

            if (type === 'LOAD_SHEET') {
                if (payload.luckysheetData) {
                    renderSheet(payload.luckysheetData, payload.fileName, payload.options);
                } else {
                    loadSheetFromFile(payload.fileUrl, payload.fileName, payload.options);
                }
            } else if (type === 'GET_DATA_AND_IMAGES') {
                try {
                    console.group("ğŸš€ [Iframe] æ”¶åˆ°æå–æ•°æ®æŒ‡ä»¤");

                    // 1. æ ¸å¿ƒåŠ¨ä½œï¼šå¼ºåˆ¶é€€å‡ºç¼–è¾‘æ¨¡å¼
                    // (å¦‚æœä¸åšè¿™ä¸€æ­¥ï¼Œæ­£åœ¨ç¼–è¾‘çš„å•å…ƒæ ¼å†…å®¹å’ŒéªŒè¯è§„åˆ™ä¸ä¼šä¿å­˜)
                    if (window.luckysheet && window.luckysheet.exitEditMode) {
                        window.luckysheet.exitEditMode();
                        console.log("-> å·²æ‰§è¡Œ exitEditModeï¼Œç¡®ä¿æ•°æ®å·²æäº¤");
                    }

                    // 2. è·å–åŸå§‹æ•°æ® (æ·±æ‹·è´ä»¥é˜²å¼•ç”¨é—®é¢˜)
                    const rawSheets = window.luckysheet.getAllSheets();
                    const sheets = JSON.parse(JSON.stringify(rawSheets));

                    // 3. [è°ƒè¯•æ¢é’ˆ] æ£€æŸ¥ç¬¬ä¸€å¼ è¡¨çš„æ•°æ®éªŒè¯æ˜¯å¦å­˜åœ¨
                    if (sheets.length > 0) {
                        const firstSheet = sheets[0];
                        // å…¼å®¹æ£€æŸ¥: dataVerification å¯èƒ½åœ¨æ ¹ç›®å½•ï¼Œä¹Ÿå¯èƒ½åœ¨ config é‡Œ
                        const rules = firstSheet.dataVerification || (firstSheet.config && firstSheet.config.dataVerification);

                        if (rules) {
                            const count = Object.keys(rules).length;
                            console.log(`âœ… [Iframeæ•°æ®æ£€æŸ¥] Sheet1 åŒ…å« ${count} æ¡éªŒè¯è§„åˆ™`);
                            if (count > 0) console.log("-> è§„åˆ™å¿«ç…§:", rules);
                        } else {
                            console.warn("âš ï¸ [Iframeæ•°æ®æ£€æŸ¥] Sheet1 æ²¡æœ‰æ£€æµ‹åˆ°éªŒè¯è§„åˆ™ (dataVerification ä¸ºç©º)");
                        }
                    }

                    // 4. å‘é€æ•°æ®å›çˆ¶çª—å£
                    const responsePayload = {
                        type: 'SHEET_DATA_WITH_IMAGES_RESPONSE',
                        payload: {
                            fileId: payload.fileId,
                            documentType: payload.documentType,
                            purpose: payload.purpose,
                            sheets: sheets, // ğŸ‘ˆ å…³é”®ï¼šè¿™é‡Œä¼ çš„æ˜¯çº¯å‡€çš„ sheets æ•°æ®
                            images: window.luckysheet.getLuckysheetfile()[0].images
                        }
                    };

                    console.log("-> æ•°æ®æ‰“åŒ…å®Œæ¯•ï¼Œå‘é€å›çˆ¶çª—å£...");
                    event.source.postMessage(responsePayload, event.origin);
                    console.groupEnd();

                } catch (e) {
                    console.error('[Iframe] è·å–æ•°æ®å¤±è´¥:', e);
                }
                return;
            } else if (type === 'EXPORT_SHEET') {
                if (window.luckysheet) {
                    handleExport(payload.fileName || 'å¯¼å‡ºæ–‡ä»¶.xlsx');
                }
            }
        });

        document.body.addEventListener('mousedown', () => {
            window.parent.postMessage({ type: 'IFRAME_CLICKED' }, window.location.origin);
        }, true);

        // --- [æ–°å¢åŠŸèƒ½ï¼šCtrl + æ»šè½®ç¼©æ”¾ (é˜²æŠ– + é˜»æ­¢æ»šåŠ¨ç‰ˆ)] ---
        // ä½¿ç”¨ capture: true (æ•è·æ¨¡å¼) ç¡®ä¿æˆ‘ä»¬åœ¨ Luckysheet å†…éƒ¨é€»è¾‘ä¹‹å‰æ‹¦æˆªäº‹ä»¶
        document.addEventListener('wheel', function (event) {

            // 1. åªæœ‰æŒ‰ä½ Ctrl æ—¶æ‰ä»‹å…¥
            if (event.ctrlKey) {

                // ã€æ ¸å¿ƒä¿®æ­£ã€‘ä¸‰è¿å‡»ï¼Œå½»åº•æ€ç­æ»šåŠ¨äº‹ä»¶
                event.preventDefault();           // 1. é˜»æ­¢æµè§ˆå™¨é»˜è®¤çš„é¡µé¢æ»šåŠ¨
                event.stopPropagation();          // 2. é˜»æ­¢äº‹ä»¶å‘ä¸Šå†’æ³¡
                event.stopImmediatePropagation(); // 3. ã€å…³é”®ã€‘é˜»æ­¢ Luckysheet å†…éƒ¨çš„æ»šåŠ¨ç›‘å¬å™¨æ‰§è¡Œ

                // --- ä¸‹é¢æ˜¯èŠ‚æµä¸ç¼©æ”¾é€»è¾‘ (ä¿æŒä¸å˜) ---

                // èŠ‚æµé”æ£€æŸ¥
                if (window._isZoomLocked) return;

                const btnMinus = document.getElementById('luckysheet-zoom-minus');
                const btnPlus = document.getElementById('luckysheet-zoom-plus');

                if (!btnMinus || !btnPlus) return;

                // ä¸Šé”
                window._isZoomLocked = true;

                // æ‰§è¡Œç¼©æ”¾
                // console.log(`[Zoom] è§¦å‘ç¼©æ”¾ (å·²æ‹¦æˆªæ»šåŠ¨)`);
                if (event.deltaY < 0) {
                    btnPlus.click();
                } else {
                    btnMinus.click();
                }

                // 100ms åè§£é”
                setTimeout(() => {
                    window._isZoomLocked = false;
                }, 100);
            }
            // å¦‚æœæ²¡æŒ‰ Ctrlï¼Œä»€ä¹ˆéƒ½ä¸åšï¼Œè®© Luckysheet æ­£å¸¸å¤„ç†æ»šåŠ¨

        }, { passive: false, capture: true }); // â˜… capture: true éå¸¸é‡è¦ï¼Œä¿è¯æˆ‘ä»¬ç¬¬ä¸€ä¸ªæ‹¿åˆ°äº‹ä»¶

        console.log('[Iframe] åŠ è½½å™¨å·²å°±ç»ªï¼Œç­‰å¾…æ¶ˆæ¯...');

    </script>
</body>

</html>