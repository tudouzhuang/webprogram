<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <title>Luckysheet Iframe Loader</title>
    <!-- 引入 Luckysheet 的 CSS -->
    <link rel='stylesheet' href='/luckysheet/plugins/css/pluginsCss.css' />
    <link rel='stylesheet' href='/luckysheet/plugins/plugins.css' />
    <link rel='stylesheet' href='/luckysheet/css/luckysheet.css' />
    <link rel='stylesheet' href='/luckysheet/assets/iconfont/iconfont.css' />
    <style>
        html,
        body,
        #luckysheet-container {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        .loader {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            font-size: 1.1em;
            color: #888;
            text-align: center;
            padding: 10px;
        }
    </style>
</head>

<body>
    <div id="luckysheet-container">
        <div class="loader">等待父窗口指令...</div>
    </div>

    <!-- 引入 JS 库 -->
    <script src="/luckysheet/plugins/js/plugin.js"></script>
    <script src="/luckysheet/luckysheet.umd.js"></script>
    <script src="/luckysheet/luckyexcel.umd.js"></script>
    <script src="/js/libs/exceljs.min.js"></script>

    <script type="module">
        // --- [1. 导入外部模块] ---
        import { exportWithExcelJS } from '/js/utils/luckysheetExporter.js';

        // --- [2. 全局变量与状态] ---
        const container = document.getElementById('luckysheet-container');
        let originalDataValidation = {};

        // --- [3. 辅助函数定义] ---

        /**
         * Debounce 防抖函数: 防止函数在短时间内被高频触发。
         */
        function debounce(func, wait) {
            let timeout;
            return function (...args) {
                const context = this;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), wait);
            };
        }

        /**
         * 核心统计与汇报函数: 计算表格数据并发送回父窗口。
         */
        function calculateAndReportStats() {
            if (!window.luckysheet) return; // 安全检查
            console.log('[Iframe] 变更已触发，准备执行统计...');

            const rules = [
                { category: '内审自检', range: 'G10:G50', ok: '√', ng: '×', na: '无' },
                { category: 'FMC自检', range: 'H10:H50', ok: '√', ng: '×', na: '无' }
            ];
            const statsResult = {};

            rules.forEach(rule => {
                try {
                    const rangeData = luckysheet.getRangeArray(rule.range);
                    let okCount = 0, ngCount = 0, naCount = 0;

                    rangeData.forEach(row => {
                        row.forEach(cellValue => {
                            if (cellValue) {
                                if (cellValue === rule.ok) okCount++;
                                else if (cellValue === rule.ng) ngCount++;
                                else if (cellValue === rule.na) naCount++;
                            }
                        });
                    });

                    const totalCount = okCount + ngCount + naCount;
                    const okPercentage = totalCount > 0 ? Math.round((okCount / totalCount) * 10000) / 100 : 0;

                    statsResult[rule.category] = {
                        category: rule.category, okCount, ngCount, naCount, totalCount, okPercentage
                    };
                } catch (e) {
                    console.error(`[Iframe] 统计规则 "${rule.category}" 执行失败:`, e);
                }
            });

            console.log('[Iframe] 统计计算完成，结果:', statsResult);

            window.parent.postMessage({
                type: 'STATS_UPDATE',
                payload: statsResult
            }, window.location.origin);
        }

        /**
         * 【【【 新增：自动标红函数 】】】
         * 当单元格的值变为 "×" 时，自动将其背景设置为红色。
         * 当值变为其他时，清除背景色。
         * @param {number} r - 单元格的行索引
         * @param {number} c - 单元格的列索引
         * @param {object} cell - 单元格的完整数据对象
         */
        function autoHighlightCell(r, c, cell) {
            // 【探头 A】: 确认函数是否被调用
            console.log(`[Highlight-Debug] autoHighlightCell 被调用！坐标: (r=${r}, c=${c})`);

            if (!window.luckysheet || !cell) {
                console.log('[Highlight-Debug] Luckysheet 实例或 cell 对象为空，已终止。');
                return;
            }

            const cellValue = cell.v ? String(cell.v).trim() : '';
            // 【探头 B】: 确认获取到的值是什么
            console.log(`[Highlight-Debug] 获取到的单元格值: "${cellValue}"`);

            const targetColumns = [4, 5, 6, 7, 8, 9, 10]; // E=4, F=5, ..., K=10

            // 【探头 C】: 确认列坐标是否在目标范围内
            if (targetColumns.includes(c)) {
                console.log(`[Highlight-Debug] ✅ 列 ${c} 在目标范围 [${targetColumns.join(',')}] 内，继续判断...`);

                if (cellValue === '×') {
                    // 【探头 D-1】: 确认是否匹配 "×"
                    console.log('[Highlight-Debug] 匹配到 "×"！准备设置红色背景...');
                    luckysheet.setCellFormat(r, c, 'bg', '#ffdddd');
                    luckysheet.setCellFormat(r, c, 'fc', '#9c0006');
                } else {
                    // 【探头 D-2】: 确认是否进入“清除颜色”的逻辑
                    if (cell.bg === '#ffdddd') {
                        console.log('[Highlight-Debug] 值不再是 "×"，且检测到旧的红色背景。准备清除颜色...');
                        luckysheet.setCellFormat(r, c, 'bg', null);
                        luckysheet.setCellFormat(r, c, 'fc', null);
                    }
                }
            } else {
                console.log(`[Highlight-Debug] ❌ 列 ${c} 不在目标范围内，已忽略。`);
            }
        }

        /**
         * 创建防抖函数的实例，延迟500ms执行。
         */
        const debouncedCalculate = debounce(calculateAndReportStats, 500);

        // --- [4. 核心功能函数] ---

        /**
         * 渲染 Luckysheet 实例。
         */
        /**
         * 渲染 Luckysheet 实例。
         * 【最终修正版】：在保留所有原有功能的基础上，增加了 cellUpdated 钩子来实现自动标红和实时统计。
         */
/**
         * 渲染 Luckysheet 实例。
         * 【最终修正版】：改用 luckysheet.setHook() 手动设置钩子，以确保注册成功。
         */
        function renderSheet(luckysheetData, fileName, options) {
            if (window.luckysheet) {
                luckysheet.destroy();
            }
            container.innerHTML = '';

            originalDataValidation = {};
            if (Array.isArray(luckysheetData)) {
                luckysheetData.forEach(sheet => {
                    if (sheet && sheet.order != null && sheet.dataVerification) {
                        originalDataValidation[sheet.order] = sheet.dataVerification;
                    }
                });
            }

            // 【【【 核心修改 1：从 finalOptions 中移除 hooks 】】】
            const finalOptions = {
                container: 'luckysheet-container',
                data: luckysheetData,
                title: fileName,
                ...options
            };

            setTimeout(() => {
                try {
                    console.log(`[Iframe] 准备创建实例...`, finalOptions);
                    luckysheet.create(finalOptions);
                    console.log(`[Iframe] 创建实例成功！`);

                    // 【【【 核心修改 2：在 create 成功后，手动设置全局钩子 】】】
                    console.log('%c[Hooks-Debug] 准备手动设置 cellUpdated 钩子...', 'color: green; font-weight: bold;');
                    
                    luckysheet.setHook({
                        cellUpdated: function (r, c, r_len, c_len) {
                            console.log(`%c[Hooks-Debug] 手动设置的 cellUpdated 钩子已触发！范围: (r=${r}, c=${c}, rows=${r_len}, cols=${c_len})`, 'color: blue; font-weight: bold;');
                            
                            for (let i = 0; i < r_len; i++) {
                                for (let j = 0; j < c_len; j++) {
                                    const currentRow = r + i;
                                    const currentCol = c + j;
                                    const cell = luckysheet.getCellValue(currentRow, currentCol);
                                    autoHighlightCell(currentRow, currentCol, cell);
                                }
                            }
                            
                            debouncedCalculate();
                        }
                    });

                    console.log('%c[Hooks-Debug] cellUpdated 钩子已手动设置成功！', 'color: green; font-weight: bold;');

                } catch (e) {
                    console.error(`[Iframe] 创建实例或设置钩子时失败:`, e);
                }
            }, 50);
        }

        /**
         * 从文件URL加载数据，并智能判断是JSON还是二进制文件。
         */
        function loadSheetFromFile(fileUrl, fileName, options) {
            container.innerHTML = `<div class="loader">正在加载数据...</div>`;

            fetch(fileUrl)
                .then(response => {
                    if (!response.ok) throw new Error(`网络错误: ${response.statusText}`);
                    const clonedResponse = response.clone();

                    return response.json()
                        .then(jsonData => {
                            console.log("[Iframe] ✅ 成功将响应解析为JSON！");
                            renderSheet(jsonData, fileName, options);
                        })
                        .catch(jsonError => {
                            console.warn("[Iframe] ⚠️ 解析为JSON失败，回退到二进制文件处理模式。");
                            container.innerHTML = `<div class="loader">正在使用备用模式解析文件...</div>`;

                            return clonedResponse.blob().then(fileBlob => {
                                LuckyExcel.transformExcelToLucky(fileBlob,
                                    exportJson => {
                                        console.log("[Iframe] ✅ LuckyExcel 解析二进制文件成功！");
                                        renderSheet(exportJson.sheets, fileName || exportJson.info.name, options);
                                    },
                                    excelError => {
                                        console.error("[Iframe] ❌ LuckyExcel 解析失败:", excelError);
                                        container.innerHTML = `<div class="loader">文件解析失败。</div>`;
                                    }
                                );
                            });
                        });
                })
                .catch(error => {
                    console.error("[Iframe] ❌ 加载文件失败:", error);
                    container.innerHTML = `<div class="loader">文件加载失败。</div>`;
                });
        }

        /**
         * 将实时获取的 sheet 数据与初始加载的数据验证规则融合。
         */
        function mergeDataWithValidation(liveSheets, validationRules) {
            return liveSheets.map(liveSheet => {
                if (liveSheet && liveSheet.order != null && validationRules[liveSheet.order]) {
                    if (!liveSheet.dataVerification || Object.keys(liveSheet.dataVerification).length === 0) {
                        liveSheet.dataVerification = validationRules[liveSheet.order];
                    }
                }
                return liveSheet;
            });
        }

        /**
         * 触发文件下载。
         */
        function downloadBlob(blob, fileName) {
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.href = url;
            link.download = fileName;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        /**
         * 处理“一键导出”的函数。
         */
        async function handleExport(fileName) {
            console.log("[Iframe] 开始复用 exportWithExcelJS 的导出流程...");
            const loaderDiv = document.createElement('div');
            loaderDiv.className = 'loader';
            loaderDiv.style.cssText = 'position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(255, 255, 255, 0.8); z-index: 10000;';
            loaderDiv.textContent = '正在生成Excel文件，请稍候...';
            container.appendChild(loaderDiv);

            try {
                const allSheetsData = luckysheet.getAllSheets();
                const blob = await exportWithExcelJS(allSheetsData);
                downloadBlob(blob, fileName);
                console.log("[Iframe] 通过复用模块，成功导出文件！");
            } catch (error) {
                console.error("[Iframe] 复用导出模块时出错:", error);
                alert("导出文件时发生错误，详情请查看控制台。");
            } finally {
                container.removeChild(loaderDiv);
            }
        }

        // --- [5. 事件监听器] ---

        /**
         * 统一的消息监听器，处理所有来自父窗口的指令。
         */
        window.addEventListener('message', function (event) {
            if (event.origin !== window.location.origin) return;
            console.log('【iframe】收到了来自父窗口的消息！类型是:', event.data.type);
            const { type, payload } = event.data;
            console.log(`[Iframe] 收到消息: type=${type}`, payload);

            if (type === 'LOAD_SHEET') {
                if (payload.luckysheetData) {
                    renderSheet(payload.luckysheetData, payload.fileName, payload.options);
                } else {
                    loadSheetFromFile(payload.fileUrl, payload.fileName, payload.options);
                }
            } else if (type === 'GET_DATA_AND_IMAGES') {
                if (window.luckysheet) {
                    const liveSheets = luckysheet.getAllSheets();
                    const mergedSheets = mergeDataWithValidation(liveSheets, originalDataValidation);

                    console.log(`[Iframe] ✅ 成功融合实时数据。准备回发...`);
                    console.log('【iframe】准备将 SHEET_DATA_WITH_IMAGES_RESPONSE 消息回发给父窗口！'); // <-- 新增日志
                    window.parent.postMessage({
                        type: 'SHEET_DATA_WITH_IMAGES_RESPONSE',
                        payload: {
                            sheets: mergedSheets,
                            purpose: payload.purpose,
                            fileId: payload.fileId,
                            documentType: payload.documentType
                        }
                    }, window.location.origin);
                }
            } else if (type === 'EXPORT_SHEET') {
                if (window.luckysheet) {
                    handleExport(payload.fileName || '导出文件.xlsx');
                }
            }
        });

        /**
         * 监听 iframe 内的点击事件，通知父窗口。
         */
        document.body.addEventListener('mousedown', () => {
            window.parent.postMessage({ type: 'IFRAME_CLICKED' }, window.location.origin);
        }, true);

        console.log('[Iframe] 加载器已就绪，等待消息...');

    </script>
</body>

</html>