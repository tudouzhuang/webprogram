<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <title>Luckysheet Iframe Loader</title>
    <!-- 引入 Luckysheet 的 CSS -->
    <link rel='stylesheet' href='/luckysheet/plugins/css/pluginsCss.css' />
    <link rel='stylesheet' href='/luckysheet/plugins/plugins.css' />
    <link rel='stylesheet' href='/luckysheet/css/luckysheet.css' />
    <link rel='stylesheet' href='/luckysheet/assets/iconfont/iconfont.css' />
    <style>
        html, body, #luckysheet-container {
            margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden;
        }
        .loader {
            display: flex; justify-content: center; align-items: center; height: 100%;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            font-size: 1.1em; color: #888; text-align: center; padding: 10px;
        }
    </style>
</head>

<body>
    <div id="luckysheet-container">
        <div class="loader">等待父窗口指令...</div>
    </div>

    <!-- 引入 JS 库 -->
    <script src="/luckysheet/plugins/js/plugin.js"></script>
    <script src="/luckysheet/luckysheet.umd.js"></script>
    <script src="/luckysheet/luckyexcel.umd.js"></script>
    <script src="/js/libs/exceljs.min.js"></script>

    <script type="module">
        // --- [1. 导入外部模块] ---
        import { exportWithExcelJS } from '/js/utils/luckysheetExporter.js';

        // --- [2. 全局变量与状态] ---
        const container = document.getElementById('luckysheet-container');
        let originalDataValidation = {}; 
        
        // --- [3. 辅助函数定义] ---

        /**
         * Debounce 防抖函数: 防止函数在短时间内被高频触发。
         */
        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                const context = this;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), wait);
            };
        }

        /**
         * 核心统计与汇报函数: 计算表格数据并发送回父窗口。
         */
        function calculateAndReportStats() {
            if (!window.luckysheet) return; // 安全检查
            console.log('[Iframe] 变更已触发，准备执行统计...');

            const rules = [
                { category: '内审自检', range: 'G10:G50', ok: '√', ng: '×', na: '无' },
                { category: 'FMC自检', range: 'H10:H50', ok: '√', ng: '×', na: '无' }
            ];
            const statsResult = {};

            rules.forEach(rule => {
                try {
                    const rangeData = luckysheet.getRangeArray(rule.range);
                    let okCount = 0, ngCount = 0, naCount = 0;
                    
                    rangeData.forEach(row => {
                        row.forEach(cellValue => {
                            if (cellValue) {
                                if (cellValue === rule.ok) okCount++;
                                else if (cellValue === rule.ng) ngCount++;
                                else if (cellValue === rule.na) naCount++;
                            }
                        });
                    });

                    const totalCount = okCount + ngCount + naCount;
                    const okPercentage = totalCount > 0 ? Math.round((okCount / totalCount) * 10000) / 100 : 0;
                    
                    statsResult[rule.category] = {
                        category: rule.category, okCount, ngCount, naCount, totalCount, okPercentage
                    };
                } catch (e) {
                    console.error(`[Iframe] 统计规则 "${rule.category}" 执行失败:`, e);
                }
            });
            
            console.log('[Iframe] 统计计算完成，结果:', statsResult);

            window.parent.postMessage({
                type: 'STATS_UPDATE',
                payload: statsResult
            }, window.location.origin);
        }

        /**
         * 创建防抖函数的实例，延迟500ms执行。
         */
        const debouncedCalculate = debounce(calculateAndReportStats, 500);

        // --- [4. 核心功能函数] ---

        /**
         * 渲染 Luckysheet 实例。
         */
        function renderSheet(luckysheetData, fileName, options) {
            if (window.luckysheet) {
                luckysheet.destroy();
            }
            container.innerHTML = '';
            
            originalDataValidation = {};
            if (Array.isArray(luckysheetData)) {
                 luckysheetData.forEach(sheet => {
                    if (sheet && sheet.order != null && sheet.dataVerification) {
                        originalDataValidation[sheet.order] = sheet.dataVerification;
                    }
                });
            }

            const finalOptions = {
                container: 'luckysheet-container',
                data: luckysheetData,
                title: fileName,
                ...options,
                // 【【【 核心修正：在这里绑定钩子 】】】
                hooks: {
                    cellValueChange: (r, c, v) => debouncedCalculate(),
                    rangePaste: (range, data) => debouncedCalculate()
                }
            };
            
            setTimeout(() => {
                try {
                    console.log(`[Iframe] 准备创建实例...`, finalOptions);
                    luckysheet.create(finalOptions);
                    console.log(`[Iframe] 创建实例成功！`);
                } catch (e) {
                    console.error(`[Iframe] 创建实例失败:`, e);
                }
            }, 50);
        }

        /**
         * 从文件URL加载数据，并智能判断是JSON还是二进制文件。
         */
        function loadSheetFromFile(fileUrl, fileName, options) {
            container.innerHTML = `<div class="loader">正在加载数据...</div>`;

            fetch(fileUrl)
                .then(response => {
                    if (!response.ok) throw new Error(`网络错误: ${response.statusText}`);
                    const clonedResponse = response.clone();

                    return response.json()
                        .then(jsonData => {
                            console.log("[Iframe] ✅ 成功将响应解析为JSON！");
                            renderSheet(jsonData, fileName, options);
                        })
                        .catch(jsonError => {
                            console.warn("[Iframe] ⚠️ 解析为JSON失败，回退到二进制文件处理模式。");
                            container.innerHTML = `<div class="loader">正在使用备用模式解析文件...</div>`;
                            
                            return clonedResponse.blob().then(fileBlob => {
                                LuckyExcel.transformExcelToLucky(fileBlob,
                                    exportJson => {
                                        console.log("[Iframe] ✅ LuckyExcel 解析二进制文件成功！");
                                        renderSheet(exportJson.sheets, fileName || exportJson.info.name, options);
                                    },
                                    excelError => {
                                        console.error("[Iframe] ❌ LuckyExcel 解析失败:", excelError);
                                        container.innerHTML = `<div class="loader">文件解析失败。</div>`;
                                    }
                                );
                            });
                        });
                })
                .catch(error => {
                    console.error("[Iframe] ❌ 加载文件失败:", error);
                    container.innerHTML = `<div class="loader">文件加载失败。</div>`;
                });
        }
        
        /**
         * 将实时获取的 sheet 数据与初始加载的数据验证规则融合。
         */
        function mergeDataWithValidation(liveSheets, validationRules) {
            return liveSheets.map(liveSheet => {
                if (liveSheet && liveSheet.order != null && validationRules[liveSheet.order]) {
                    if (!liveSheet.dataVerification || Object.keys(liveSheet.dataVerification).length === 0) {
                        liveSheet.dataVerification = validationRules[liveSheet.order];
                    }
                }
                return liveSheet;
            });
        }
        
        /**
         * 触发文件下载。
         */
        function downloadBlob(blob, fileName) {
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.href = url;
            link.download = fileName;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        /**
         * 处理“一键导出”的函数。
         */
        async function handleExport(fileName) {
            console.log("[Iframe] 开始复用 exportWithExcelJS 的导出流程...");
            const loaderDiv = document.createElement('div');
            loaderDiv.className = 'loader';
            loaderDiv.style.cssText = 'position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(255, 255, 255, 0.8); z-index: 10000;';
            loaderDiv.textContent = '正在生成Excel文件，请稍候...';
            container.appendChild(loaderDiv);

            try {
                const allSheetsData = luckysheet.getAllSheets();
                const blob = await exportWithExcelJS(allSheetsData);
                downloadBlob(blob, fileName);
                console.log("[Iframe] 通过复用模块，成功导出文件！");
            } catch (error) {
                console.error("[Iframe] 复用导出模块时出错:", error);
                alert("导出文件时发生错误，详情请查看控制台。");
            } finally {
                container.removeChild(loaderDiv);
            }
        }

        // --- [5. 事件监听器] ---

        /**
         * 统一的消息监听器，处理所有来自父窗口的指令。
         */
        window.addEventListener('message', function (event) {
            if (event.origin !== window.location.origin) return;
            console.log('【iframe】收到了来自父窗口的消息！类型是:', event.data.type);
            const { type, payload } = event.data;
            console.log(`[Iframe] 收到消息: type=${type}`, payload);

            if (type === 'LOAD_SHEET') {
                if (payload.luckysheetData) {
                    renderSheet(payload.luckysheetData, payload.fileName, payload.options);
                } else {
                    loadSheetFromFile(payload.fileUrl, payload.fileName, payload.options);
                }
            } else if (type === 'GET_DATA_AND_IMAGES') {
                if (window.luckysheet) {
                    const liveSheets = luckysheet.getAllSheets();
                    const mergedSheets = mergeDataWithValidation(liveSheets, originalDataValidation);
                    
                    console.log(`[Iframe] ✅ 成功融合实时数据。准备回发...`);
                    console.log('【iframe】准备将 SHEET_DATA_WITH_IMAGES_RESPONSE 消息回发给父窗口！'); // <-- 新增日志
                    window.parent.postMessage({
                        type: 'SHEET_DATA_WITH_IMAGES_RESPONSE',
                        payload: {
                            sheets: mergedSheets,
                            purpose: payload.purpose,
                            fileId: payload.fileId,
                            documentType: payload.documentType
                        }
                    }, window.location.origin);
                }
            } else if (type === 'EXPORT_SHEET') {
                if (window.luckysheet) {
                    handleExport(payload.fileName || '导出文件.xlsx');
                }
            }
        });

        /**
         * 监听 iframe 内的点击事件，通知父窗口。
         */
        document.body.addEventListener('mousedown', () => {
            window.parent.postMessage({ type: 'IFRAME_CLICKED' }, window.location.origin);
        }, true);
        
        console.log('[Iframe] 加载器已就绪，等待消息...');

    </script>
</body>

</html>