<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>Luckysheet Iframe Loader</title>
    <!-- 引入 Luckysheet 的 CSS -->
    <link rel='stylesheet' href='/luckysheet/plugins/css/pluginsCss.css' />
    <link rel='stylesheet' href='/luckysheet/plugins/plugins.css' />
    <link rel='stylesheet' href='/luckysheet/css/luckysheet.css' />
    <link rel='stylesheet' href='/luckysheet/assets/iconfont/iconfont.css' />
    <style>
        html, body, #luckysheet-container { 
            margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; 
        }
        .loader {
            display: flex; justify-content: center; align-items: center; height: 100%;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            font-size: 1.1em; color: #888; text-align: center; padding: 10px;
        }
    </style>
</head>
<body>
    <div id="luckysheet-container">
        <div class="loader">等待父窗口指令...</div>
    </div>

    <!-- 引入 JS 库 -->
    <script src="/luckysheet/plugins/js/plugin.js"></script>
    <script src="/luckysheet/luckysheet.umd.js"></script>
    <script src="/luckysheet/luckyexcel.umd.js"></script>
    <!-- SheetJS 在 iframe 中不再需要，导出由父组件完成 -->
    <!-- <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script> -->

    <!-- 省略了 HTML head 和 body 标签 -->

    <script>
        const container = document.getElementById('luckysheet-container');

        window.addEventListener('message', function(event) {
            if (event.origin !== window.location.origin) return;

            const { type, payload } = event.data;
            console.log(`[Iframe] 收到消息: type=${type}`, payload);

            if (type === 'LOAD_SHEET') {
                // 【新增逻辑】: 检查 payload 中是否直接包含了 Luckysheet 数据
                if (payload.luckysheetData) {
                    console.log("[Iframe] 检测到直接传入的 Luckysheet 数据，将使用它进行渲染。");
                    renderSheet(payload.luckysheetData, payload.fileName, payload.options);
                } else {
                    loadSheetFromFile(payload.fileUrl, payload.fileName, payload.options);
                }
            } 
            else if (type === 'GET_DATA_AND_IMAGES') {
                 if (window.luckysheet) {
                    const liveSheets = luckysheet.getAllSheets();
                    const structuralData = luckysheet.getLuckysheetfile();
                    const validationMap = new Map();
                    if (Array.isArray(structuralData)) {
                        structuralData.forEach(sheet => {
                            if (sheet && sheet.order != null && sheet.dataVerification) {
                                validationMap.set(sheet.order, sheet.dataVerification);
                            }
                        });
                    }
                    const mergedSheets = liveSheets.map(liveSheet => {
                        if (liveSheet && liveSheet.order != null && validationMap.has(liveSheet.order)) {
                            liveSheet.dataVerification = validationMap.get(liveSheet.order);
                        }
                        return liveSheet;
                    });
                    
                    console.log(`[Iframe] ✅ 成功融合实时数据与数据验证规则。准备回发...`);
                    
                    window.parent.postMessage({ 
                        type: 'SHEET_DATA_WITH_IMAGES_RESPONSE', 
                        payload: {
                            sheets: mergedSheets
                        }
                    }, window.location.origin);

                } else {
                    console.error('[Iframe] 错误: 尝试获取数据时，Luckysheet实例不存在。');
                }
            }
        });

        /**
         * 新增：直接使用 Luckysheet JSON 数据进行渲染
         */
        function renderSheet(luckysheetData, fileName, options) {
            if (window.luckysheet) {
                luckysheet.destroy();
            }
            container.innerHTML = '';
            const finalOptions = {
                container: 'luckysheet-container',
                data: luckysheetData, // 直接使用传入的数据
                title: fileName,
                ...options
            };
            setTimeout(() => {
                try {
                    console.log(`[Iframe] 准备使用传入的JSON创建实例...`, finalOptions);
                    luckysheet.create(finalOptions);
                    console.log(`[Iframe] 使用传入的JSON创建实例成功！`);
                } catch (e) {
                    console.error(`[Iframe] 使用JSON创建实例失败:`, e);
                }
            }, 50);
        }

        /**
         * 原有的：从文件URL加载
         */
        function loadSheetFromFile(fileUrl, fileName, options) {
            container.innerHTML = `<div class="loader">正在下载文件...</div>`;
            fetch(fileUrl)
                .then(response => response.blob())
                .then(fileBlob => {
                    container.innerHTML = `<div class="loader">文件下载成功，正在解析...</div>`;
                    LuckyExcel.transformExcelToLucky(fileBlob, 
                        function(exportJson) {
                            renderSheet(exportJson.sheets, fileName || exportJson.info.name, options);
                        },
                        function(error) {
                            container.innerHTML = `<div class="loader">文件解析失败。</div>`;
                        }
                    );
                })
                .catch(error => {
                    container.innerHTML = `<div class="loader">文件加载失败。</div>`;
                });
        }
        
        console.log('[Iframe] 加载器已就绪，等待消息...');
    </script>
</body>
</html>