<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>Luckysheet Iframe Loader</title>
    <!-- 引入 Luckysheet 的 CSS -->
    <link rel='stylesheet' href='/luckysheet/plugins/css/pluginsCss.css' />
    <link rel='stylesheet' href='/luckysheet/plugins/plugins.css' />
    <link rel='stylesheet' href='/luckysheet/css/luckysheet.css' />
    <link rel='stylesheet' href='/luckysheet/assets/iconfont/iconfont.css' />
    <style>
        html, body, #luckysheet-container { 
            margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; 
        }
        .loader {
            display: flex; justify-content: center; align-items: center; height: 100%;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            font-size: 1.1em; color: #888; text-align: center; padding: 10px;
        }
    </style>
</head>
<body>
    <div id="luckysheet-container">
        <div class="loader">等待父窗口指令...</div>
    </div>

    <!-- 引入 JS 库 -->
    <script src="/luckysheet/plugins/js/plugin.js"></script>
    <script src="/luckysheet/luckysheet.umd.js"></script>
    <script src="/luckysheet/luckyexcel.umd.js"></script>
    <!-- SheetJS 在 iframe 中不再需要，导出由父组件完成 -->
    <!-- <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script> -->

    <script>
        const container = document.getElementById('luckysheet-container');
    
        // --- 监听来自父窗口的消息 ---
        window.addEventListener('message', function(event) {
            if (event.origin !== window.location.origin) return;
            const { type, payload } = event.data;
            // console.log(`[Iframe] 收到消息: type=${type}`, payload);
    
            switch (type) {
                case 'LOAD_SHEET':
                    loadSheet(payload);
                    break;
                case 'GET_DATA_AND_IMAGES':
                    sendDataToParent();
                    break;
                default:
                    console.warn(`[Iframe] 收到未知消息类型: ${type}`);
            }
        });
    
        // --- 加载和渲染 Luckysheet 的核心函数 ---
        function loadSheet({ fileUrl, fileName, options }) {
            if (!fileUrl) {
                container.innerHTML = `<div class="loader">错误：父窗口未提供文件URL。</div>`;
                console.error("[Iframe-ERROR] loadSheet: fileUrl is missing.", { fileUrl, fileName, options });
                return;
            }
    
            container.innerHTML = `<div class="loader">正在下载文件...</div>`;
    
            fetch(fileUrl)
                .then(response => {
                    if (!response.ok) throw new Error(`网络错误: ${response.status} ${response.statusText}`);
                    return response.blob();
                })
                .then(fileBlob => {
                    container.innerHTML = `<div class="loader">文件下载成功，正在解析(包含图片)...</div>`;
    
                    // 【核心修正】: 创建一个配置对象，强制 LuckyExcel 解析图片
                    const luckyExcelOptions = {
                        getPictures: true
                    };
    
                    LuckyExcel.transformExcelToLucky(
                        fileBlob, 
                        function(exportJson) {
                            console.log("[Iframe] LuckyExcel解析成功，检查JSON中的图片:", exportJson.sheets.map(s => s.images));
    
                            if (window.luckysheet) {
                                try { luckysheet.destroy(); } catch (e) { console.warn("[Iframe] 销毁旧实例时出错: ", e); }
                            }
    
                            if (!exportJson.sheets || exportJson.sheets.length === 0) {
                                container.innerHTML = '<div class="loader">文件内容为空或格式无法解析。</div>';
                                return;
                            }
                            
                            container.innerHTML = ''; 
                            
                            const finalOptions = {
                                container: 'luckysheet-container',
                                data: exportJson.sheets,
                                title: fileName || exportJson.info.name || "未命名",
                                ...options
                            };
                            
                            setTimeout(() => {
                                try {
                                    console.log(`[Iframe] 准备创建 Luckysheet 实例...`, finalOptions);
                                    luckysheet.create(finalOptions);
                                    console.log(`[Iframe] Luckysheet 实例创建成功！`);
                                } catch(e) {
                                     console.error(`[Iframe] luckysheet.create 失败:`, e);
                                     container.innerHTML = `<div class="loader">渲染失败: ${e.message}</div>`;
                                }
                            }, 50);
                        },
                        function(error) {
                            console.error(`[Iframe] LuckyExcel 解析失败:`, error);
                            container.innerHTML = `<div class="loader">文件解析失败，请检查文件格式。</div>`;
                        },
                        // 【核心修正】: 将配置对象作为最后一个参数传入
                        luckyExcelOptions
                    );
                })
                .catch(error => {
                    console.error(`[Iframe] 文件下载失败 (${fileUrl}):`, error);
                    container.innerHTML = `<div class="loader">文件加载失败: ${error.message}</div>`;
                });
        }
        
        // --- 将数据发送回父窗口的函数 (保持不变) ---
        function sendDataToParent() {
            if (window.luckysheet) {
                const luckysheetFile = luckysheet.getLuckysheetfile();
                console.log(`[Iframe] 准备回发最原始的 luckysheetFile 数据结构:`, luckysheetFile);
                window.parent.postMessage({ 
                    type: 'SHEET_DATA_WITH_IMAGES_RESPONSE', 
                    payload: { sheets: luckysheetFile }
                }, window.location.origin);
            } else {
                console.error('[Iframe] 错误: 尝试获取数据时，Luckysheet实例不存在。');
            }
        }
        
        console.log('[Iframe] 加载器已准备就绪。');
    </script>
</body>
</html>