<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <title>Luckysheet Iframe Loader</title>
    <!-- 引入 Luckysheet 的 CSS -->
    <link rel='stylesheet' href='/luckysheet/plugins/css/pluginsCss.css' />
    <link rel='stylesheet' href='/luckysheet/plugins/plugins.css' />
    <link rel='stylesheet' href='/luckysheet/css/luckysheet.css' />
    <link rel='stylesheet' href='/luckysheet/assets/iconfont/iconfont.css' />
    <style>
        html,
        body,
        #luckysheet-container {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        .loader {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            font-size: 1.1em;
            color: #888;
            text-align: center;
            padding: 10px;
        }
    </style>
</head>

<body>
    <div id="luckysheet-container">
        <div class="loader">等待父窗口指令...</div>
    </div>

    <!-- 引入 JS 库 -->
    <script src="/luckysheet/plugins/js/plugin.js"></script>
    <script src="/luckysheet/luckysheet.umd.js"></script>
    <script src="/luckysheet/luckyexcel.umd.js"></script>
    <script src="/js/libs/exceljs.min.js"></script>

    <!-- 【【【 核心修改：将 script 标签类型改为 module 以支持 import 】】】 -->
    <script type="module">
        // --- [NEW] 导入外部的、可复用的导出函数 ---
        import { exportWithExcelJS } from '/js/utils/luckysheetExporter.js';

        const container = document.getElementById('luckysheet-container');
        let originalDataValidation = {}; 
        let lastLoadedData = null;

        // 监听来自父窗口的消息
        window.addEventListener('message', function (event) {
            // 安全检查: 确保消息来自同源
            if (event.origin !== window.location.origin) return;

            const { type, payload } = event.data;
            console.log(`[Iframe] 收到消息: type=${type}`, payload);

            if (type === 'LOAD_SHEET') {
                if (payload.luckysheetData) {
                    renderSheet(payload.luckysheetData, payload.fileName, payload.options);
                } else {
                    loadSheetFromFile(payload.fileUrl, payload.fileName, payload.options);
                }
            }
            else if (type === 'GET_DATA_AND_IMAGES') {
                if (window.luckysheet) {
                    const liveSheets = luckysheet.getAllSheets();
                    const mergedSheets = mergeDataWithValidation(liveSheets, originalDataValidation);
                    
                    console.log(`[Iframe] ✅ 成功融合实时数据与数据验证规则。准备回发...`);

                    window.parent.postMessage({
                        type: 'SHEET_DATA_WITH_IMAGES_RESPONSE',
                        payload: {
                            sheets: mergedSheets,
                            purpose: event.data.payload.purpose,
                            fileId: event.data.payload.fileId,
                            documentType: event.data.payload.documentType
                        }
                    }, window.location.origin);

                } else {
                    console.error('[Iframe] 错误: 尝试获取数据时，Luckysheet实例不存在。');
                }
            }
            // --- [MODIFIED] 修改处理 EXPORT_SHEET 指令的逻辑 ---
            else if (type === 'EXPORT_SHEET') {
                if (window.luckysheet) {
                    const fileName = payload.fileName || '导出文件.xlsx';
                    // 直接调用新的、独立的 handleExport 函数
                    handleExport(fileName);
                } else {
                    console.error('[Iframe] 错误: 尝试导出时，Luckysheet实例不存在。');
                }
            }
        });

        // --- [NEW] 专门用于处理“一键导出”的函数 ---
        async function handleExport(fileName) {
            console.log("[Iframe] 开始复用 exportWithExcelJS 的导出流程...");
            
            // 临时显示加载状态
            const loaderDiv = document.createElement('div');
            loaderDiv.className = 'loader';
            loaderDiv.style.position = 'absolute';
            loaderDiv.style.top = '0';
            loaderDiv.style.left = '0';
            loaderDiv.style.width = '100%';
            loaderDiv.style.height = '100%';
            loaderDiv.style.backgroundColor = 'rgba(255, 255, 255, 0.8)';
            loaderDiv.style.zIndex = '10000';
            loaderDiv.textContent = '正在生成Excel文件，请稍候...';
            container.appendChild(loaderDiv);

            try {
                // 1. 直接从 Luckysheet 实例获取实时、完整的数据
                const allSheetsData = luckysheet.getAllSheets();
                
                // 2. 调用从外部模块导入的通用导出函数
                const blob = await exportWithExcelJS(allSheetsData);
                
                // 3. 触发下载
                downloadBlob(blob, fileName);
                
                console.log("[Iframe] 通过复用模块，成功导出文件！");

            } catch (error) {
                console.error("[Iframe] 复用导出模块时出错:", error);
                alert("导出文件时发生错误，详情请查看控制台。");
            } finally {
                // 移除加载提示
                container.removeChild(loaderDiv);
            }
        }

        // --- 以下函数保持不变 ---

        function renderSheet(luckysheetData, fileName, options) {
            lastLoadedData = { luckysheetData, fileName, options };
            if (window.luckysheet) {
                luckysheet.destroy();
            }
            container.innerHTML = '';
            
            originalDataValidation = {};
            if (Array.isArray(luckysheetData)) {
                 luckysheetData.forEach(sheet => {
                    if (sheet && sheet.order != null && sheet.dataVerification) {
                        originalDataValidation[sheet.order] = sheet.dataVerification;
                    }
                });
            }

            const finalOptions = {
                container: 'luckysheet-container',
                data: luckysheetData,
                title: fileName,
                ...options
            };
            
            setTimeout(() => {
                try {
                    console.log(`[Iframe] 准备使用传入的JSON创建实例...`, finalOptions);
                    luckysheet.create(finalOptions);
                    console.log(`[Iframe] 使用传入的JSON创建实例成功！`);
                } catch (e) {
                    console.error(`[Iframe] 使用JSON创建实例失败:`, e);
                }
            }, 50);
        }

        function loadSheetFromFile(fileUrl, fileName, options) {
            container.innerHTML = `<div class="loader">正在下载文件...</div>`;
            fetch(fileUrl)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`网络错误: ${response.statusText}`);
                    }
                    return response.blob();
                })
                .then(fileBlob => {
                    container.innerHTML = `<div class="loader">文件下载成功，正在解析...</div>`;
                    LuckyExcel.transformExcelToLucky(fileBlob,
                        function (exportJson) {
                            renderSheet(exportJson.sheets, fileName || exportJson.info.name, options);
                        },
                        function (error) {
                            console.error("LuckyExcel 解析失败:", error);
                            container.innerHTML = `<div class="loader">文件解析失败。请确认文件是有效的.xlsx格式。</div>`;
                        }
                    );
                })
                .catch(error => {
                    console.error("加载文件失败:", error);
                    container.innerHTML = `<div class="loader">文件加载失败。</div>`;
                });
        }
        
        function mergeDataWithValidation(liveSheets, validationRules) {
            return liveSheets.map(liveSheet => {
                if (liveSheet && liveSheet.order != null && validationRules[liveSheet.order]) {
                    if (!liveSheet.dataVerification || Object.keys(liveSheet.dataVerification).length === 0) {
                        liveSheet.dataVerification = validationRules[liveSheet.order];
                    }
                }
                return liveSheet;
            });
        }
        
        function downloadBlob(blob, fileName) {
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.href = url;
            link.download = fileName;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        document.body.addEventListener('mousedown', () => {
            // 步骤2：一旦发生点击，就立即向父页面发送一个“我被点了”的消息
            console.log('[Iframe] 检测到点击，通知父页面准备恢复滚动位置。');
            window.parent.postMessage({ type: 'IFRAME_CLICKED' }, window.location.origin);
        }, true); // 使用捕获阶段，确保能最早监听到点击

        // 步骤3：您已有的 message 监听器保持不变
        window.addEventListener('message', function (event) {
            // ... (您已有的处理 LOAD_SHEET, GET_DATA_AND_IMAGES, EXPORT_SHEET 的逻辑)
        });
        console.log('[Iframe] 加载器已就绪，等待消息...');
    </script>
</body>

</html>