<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <title>Luckysheet Iframe Loader</title>
    <link rel='stylesheet' href='/luckysheet/plugins/css/pluginsCss.css' />
    <link rel='stylesheet' href='/luckysheet/plugins/plugins.css' />
    <link rel='stylesheet' href='/luckysheet/css/luckysheet.css' />
    <link rel='stylesheet' href='/luckysheet/assets/iconfont/iconfont.css' />
    <style>
        html,
        body,
        #luckysheet-container {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        .loader {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            font-size: 1.1em;
            color: #888;
            text-align: center;
            padding: 10px;
        }
    </style>
</head>

<body>
    <div id="luckysheet-container">
        <div class="loader">ç­‰å¾…çˆ¶çª—å£æŒ‡ä»¤...</div>
    </div>

    <script src="/luckysheet/plugins/js/plugin.js"></script>
    <script src="/luckysheet/luckysheet.umd.js"></script>
    <script src="/luckysheet/luckyexcel.umd.js"></script>
    <script src="/js/libs/exceljs.min.js"></script>

    <script type="module">
        // --- [1. å¯¼å…¥å¤–éƒ¨æ¨¡å—] ---
        import { exportWithExcelJS } from '/js/utils/luckysheetExporter.js';

        // --- [2. å…¨å±€å˜é‡ä¸çŠ¶æ€] ---
        const container = document.getElementById('luckysheet-container');
        let originalDataValidation = {};
        let originalRowlen = {};

        // --- [3. è¾…åŠ©å‡½æ•°å®šä¹‰] ---
        
        /**
         * æ¢å¤è¡Œé«˜å‡½æ•°
         */
        function restoreRowHeight(startRow, rowCount) {
            // ç¡®ä¿ luckysheet å®ä¾‹å­˜åœ¨
            if (!window.luckysheet) return;

            for (let i = 0; i < rowCount; i++) {
                const rowIndex = String(startRow + i);
                const originalHeight = originalRowlen[rowIndex];

                if (originalHeight !== undefined) {
                    const currentHeight = luckysheet.getRowHeight([parseInt(rowIndex)])[rowIndex];

                    if (currentHeight !== originalHeight) {
                        console.log(`[Row Height Fix] æ£€æµ‹åˆ°è¡Œ ${parseInt(rowIndex) + 1} é«˜åº¦è¢«è‡ªåŠ¨ä¿®æ”¹ï¼Œæ­£åœ¨ä» ${currentHeight} æ¢å¤è‡³ ${originalHeight}`);
                        luckysheet.setRowHeight({ [rowIndex]: originalHeight });
                    }
                }
            }
        }

        /**
         * Debounce é˜²æŠ–å‡½æ•°
         */
        function debounce(func, wait) {
            let timeout;
            return function (...args) {
                const context = this;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), wait);
            };
        }

        /**
         * æ ¸å¿ƒç»Ÿè®¡ä¸æ±‡æŠ¥å‡½æ•°
         */
        function calculateAndReportStats() {
            if (!window.luckysheet) return; // å®‰å…¨æ£€æŸ¥
            // console.log('[Iframe] å˜æ›´å·²è§¦å‘ï¼Œå‡†å¤‡æ‰§è¡Œç»Ÿè®¡...');

            const rules = [
                { category: 'å†…å®¡è‡ªæ£€', range: 'G10:G50', ok: 'âˆš', ng: 'Ã—', na: 'æ— ' },
                { category: 'FMCè‡ªæ£€', range: 'H10:H50', ok: 'âˆš', ng: 'Ã—', na: 'æ— ' }
            ];
            const statsResult = {};

            rules.forEach(rule => {
                try {
                    const rangeData = luckysheet.getRangeArray(rule.range);
                    let okCount = 0, ngCount = 0, naCount = 0;

                    rangeData.forEach(row => {
                        row.forEach(cellValue => {
                            if (cellValue) {
                                if (cellValue === rule.ok) okCount++;
                                else if (cellValue === rule.ng) ngCount++;
                                else if (cellValue === rule.na) naCount++;
                            }
                        });
                    });

                    const totalCount = okCount + ngCount + naCount;
                    const okPercentage = totalCount > 0 ? Math.round((okCount / totalCount) * 10000) / 100 : 0;

                    statsResult[rule.category] = {
                        category: rule.category, okCount, ngCount, naCount, totalCount, okPercentage
                    };
                } catch (e) {
                    console.error(`[Iframe] ç»Ÿè®¡è§„åˆ™ "${rule.category}" æ‰§è¡Œå¤±è´¥:`, e);
                }
            });

            // console.log('[Iframe] ç»Ÿè®¡è®¡ç®—å®Œæˆï¼Œç»“æœ:', statsResult);

            window.parent.postMessage({
                type: 'STATS_UPDATE',
                payload: statsResult
            }, window.location.origin);
        }

        /**
         * è‡ªåŠ¨æ ‡çº¢å‡½æ•°
         */
        function autoHighlightCell(r, c, cell) {
            // ã€æ¢å¤´ Aã€‘: ç¡®è®¤å‡½æ•°æ˜¯å¦è¢«è°ƒç”¨
            // console.log(`[Highlight-Debug] autoHighlightCell è¢«è°ƒç”¨ï¼åæ ‡: (r=${r}, c=${c})`);

            if (!window.luckysheet || !cell) {
                // console.log('[Highlight-Debug] Luckysheet å®ä¾‹æˆ– cell å¯¹è±¡ä¸ºç©ºï¼Œå·²ç»ˆæ­¢ã€‚');
                return;
            }

            const cellValue = cell.v ? String(cell.v).trim() : '';
            const targetColumns = [4, 5, 6, 7, 8, 9, 10]; // E=4, F=5, ..., K=10

            // ã€æ¢å¤´ Cã€‘: ç¡®è®¤åˆ—åæ ‡æ˜¯å¦åœ¨ç›®æ ‡èŒƒå›´å†…
            if (targetColumns.includes(c)) {
                if (cellValue === 'Ã—') {
                    // ã€æ¢å¤´ D-1ã€‘: ç¡®è®¤æ˜¯å¦åŒ¹é… "Ã—"
                    luckysheet.setCellFormat(r, c, 'bg', '#ffdddd');
                    luckysheet.setCellFormat(r, c, 'fc', '#9c0006');
                } else {
                    // ã€æ¢å¤´ D-2ã€‘: ç¡®è®¤æ˜¯å¦è¿›å…¥â€œæ¸…é™¤é¢œè‰²â€çš„é€»è¾‘
                    if (cell.bg === '#ffdddd') {
                        luckysheet.setCellFormat(r, c, 'bg', null);
                        luckysheet.setCellFormat(r, c, 'fc', null);
                    }
                }
            }
        }

        /**
         * åˆ›å»ºé˜²æŠ–å‡½æ•°çš„å®ä¾‹ï¼Œå»¶è¿Ÿ500msæ‰§è¡Œã€‚
         */
        const debouncedCalculate = debounce(calculateAndReportStats, 500);

        // --- [4. æ ¸å¿ƒåŠŸèƒ½å‡½æ•°] ---

        /**
         * æ¸²æŸ“ Luckysheet å®ä¾‹ (å®Œæ•´é€»è¾‘ + ä¿®å¤å´©æºƒ + ç§»é™¤ getFlowdata ä¾èµ–)
         */
        function renderSheet(luckysheetData, fileName, options) {
            // æ­¥éª¤ 1: é”€æ¯æ—§å®ä¾‹
            if (window.luckysheet) {
                try {
                    luckysheet.destroy();
                } catch (e) { console.warn("é”€æ¯æ—§å®ä¾‹å‡ºé”™:", e); }
            }
            container.innerHTML = '';

            // --- [æ•°æ®é˜²å¾¡æ€§å¤„ç†] ---
            let validData = luckysheetData;
            
            // 1. å¦‚æœæ•°æ®ä¸ºç©ºæˆ–éæ•°ç»„ï¼Œåˆå§‹åŒ–é»˜è®¤é¡µ
            if (!Array.isArray(validData) || validData.length === 0) {
                console.warn("[Iframe] æ•°æ®ä¸ºç©ºï¼Œåˆå§‹åŒ–ä¸ºé»˜è®¤ Sheet1ã€‚");
                validData = [{
                    name: "Sheet1",
                    status: 1,
                    order: 0,
                    celldata: [],
                    config: {}
                }];
            } else {
                // æ·±æ‹·è´ï¼Œé˜²æ­¢ä¿®æ”¹å½±å“åŸå§‹æ•°æ®
                try { validData = JSON.parse(JSON.stringify(validData)); } catch(e) {}
            }

            // 2. ç¡®ä¿å¿…ç„¶æœ‰ä¸€ä¸ªæ¿€æ´»çš„ Sheet (status: 1)
            let hasActive = false;
            validData.forEach((sheet) => {
                // è¡¥å…¨å¿…è¦å­—æ®µé˜²æ­¢æŠ¥é”™
                if (!sheet.celldata) sheet.celldata = [];
                if (!sheet.config) sheet.config = {};
                // åˆå§‹åŒ–ç¼©æ”¾æ¯”ä¾‹ (åŸºäºæ–‡æ¡£)
                if (sheet.zoomRatio == null) sheet.zoomRatio = 1;

                if (sheet.status === 1) hasActive = true;
            });

            if (!hasActive) {
                console.warn("[Iframe] å¼ºåˆ¶æ¿€æ´»ç¬¬ 0 ä¸ª Sheet");
                validData[0].status = 1;
            }

            // æ­¥éª¤ 2: å¤‡ä»½åŸå§‹æ•°æ®
            originalDataValidation = {};
            validData.forEach(sheet => {
                if (sheet && sheet.order != null && sheet.dataVerification) {
                    originalDataValidation[sheet.order] = sheet.dataVerification;
                }
            });

            // å¤‡ä»½åŸå§‹è¡Œé«˜
            if (validData[0] && validData[0].config && validData[0].config.rowlen) {
                originalRowlen = { ...validData[0].config.rowlen };
                console.log("[Iframe] åŸå§‹è¡Œé«˜å·²å¤‡ä»½:", originalRowlen);
            } else {
                originalRowlen = {};
            }

            // æ­¥éª¤ 3: ç»„è£…é…ç½®å¯¹è±¡
            const finalOptions = {
                container: 'luckysheet-container',
                data: validData,
                title: fileName,
                lang: 'zh',
                ...options
            };

            // æ­¥éª¤ 4: åˆ›å»ºå®ä¾‹
            try {
                console.log(`[Iframe] å‡†å¤‡åˆ›å»ºå®ä¾‹...`);
                luckysheet.create(finalOptions);
                console.log(`[Iframe] åˆ›å»ºå®ä¾‹æˆåŠŸï¼`);
            } catch (createError) {
                console.error("ğŸ”¥ åˆ›å»º Luckysheet å®ä¾‹å¤±è´¥:", createError);
                return;
            }

            // æ­¥éª¤ 5: å»¶è¿Ÿæ‰§è¡Œ Refresh å’Œ Hook (ä¿®å¤æ ¸å¿ƒ)
            setTimeout(() => {
                try {
                    // å…¨å±€é…ç½®
                    if (window.luckysheet) {
                        luckysheet.luckysheetautofixrowlen = false;
                        console.log("[Iframe] é…ç½® luckysheetautofixrowlen = falseã€‚");
                    }

                    // å°è¯• Refresh (ä¸ä¾èµ– getFlowdata æ£€æŸ¥ï¼Œç›´æ¥å°è¯•)
                    try {
                        luckysheet.refresh();
                        console.log("[Iframe] luckysheet.refresh() æ‰§è¡ŒæˆåŠŸã€‚");
                    } catch (refreshError) {
                        console.warn("[Iframe] refresh() æ‰§è¡Œå—é˜» (é€šå¸¸ä¸å½±å“æ˜¾ç¤º):", refreshError.message);
                    }

                    // --- è®¾ç½® Hooks (å®Œå…¨ç§»é™¤ getFlowdata ä¾èµ–) ---
                    if (window.luckysheet && !window.luckysheet.hooks) {
                        window.luckysheet.hooks = {};
                    }
                    
                    window.luckysheet.hooks.cellUpdated = function (r, c, r_len, c_len) {
                        try {
                            // ä½¿ç”¨ getAllSheets æ›¿ä»£ getFlowdata ä»¥é¿å…æŠ¥é”™
                            const allSheets = luckysheet.getAllSheets();
                            // æŸ¥æ‰¾å½“å‰æ¿€æ´»çš„ sheet
                            const currentSheet = allSheets.find(s => s.status === 1) || allSheets[0];
                            
                            // å®‰å…¨è·å–å•å…ƒæ ¼æ•°æ®
                            if (currentSheet && currentSheet.data && currentSheet.data[r] && currentSheet.data[r][c]) {
                                const cell = currentSheet.data[r][c];
                                
                                // æ‰§è¡ŒåŸæ¥çš„ä¸šåŠ¡é€»è¾‘
                                autoHighlightCell(r, c, cell);
                                debouncedCalculate();
                            }
                        } catch (hookError) {
                            console.error("[Hook Error] å•å…ƒæ ¼æ›´æ–°å¤„ç†å‡ºé”™:", hookError);
                        }
                    };
                    console.log("[Iframe] Hooks è®¾ç½®å®Œæˆã€‚");

                } catch (e) {
                    console.error(`[Iframe] å»¶è¿Ÿé…ç½®é˜¶æ®µå¤±è´¥:`, e);
                }
            }, 300); // å¢åŠ å»¶è¿Ÿåˆ° 300ms ç¡®ä¿ç¨³å®š
        }

        /**
         * ä»æ–‡ä»¶URLåŠ è½½æ•°æ®
         */
        function loadSheetFromFile(fileUrl, fileName, options) {
            container.innerHTML = `<div class="loader">æ­£åœ¨åŠ è½½æ•°æ®...</div>`;

            fetch(fileUrl)
                .then(response => {
                    if (!response.ok) throw new Error(`ç½‘ç»œé”™è¯¯: ${response.statusText}`);
                    const clonedResponse = response.clone();

                    return response.json()
                        .then(jsonData => {
                            console.log("[Iframe] âœ… æˆåŠŸå°†å“åº”è§£æä¸ºJSONï¼");
                            // å…¼å®¹ç›´æ¥æ˜¯æ•°ç»„æˆ–å¯¹è±¡åŒ…å« sheets çš„æƒ…å†µ
                            const dataToRender = Array.isArray(jsonData) ? jsonData : (jsonData.sheets || []);
                            renderSheet(dataToRender, fileName, options);
                        })
                        .catch(jsonError => {
                            console.warn("[Iframe] âš ï¸ è§£æä¸ºJSONå¤±è´¥ï¼Œå›é€€åˆ°äºŒè¿›åˆ¶æ–‡ä»¶å¤„ç†æ¨¡å¼ã€‚");
                            container.innerHTML = `<div class="loader">æ­£åœ¨ä½¿ç”¨å¤‡ç”¨æ¨¡å¼è§£ææ–‡ä»¶...</div>`;

                            return clonedResponse.blob().then(fileBlob => {
                                LuckyExcel.transformExcelToLucky(fileBlob,
                                    exportJson => {
                                        console.log("[Iframe] âœ… LuckyExcel è§£æäºŒè¿›åˆ¶æ–‡ä»¶æˆåŠŸï¼");
                                        const sheets = exportJson.sheets || [];
                                        const name = (exportJson.info && exportJson.info.name) || fileName;
                                        renderSheet(sheets, name, options);
                                    },
                                    excelError => {
                                        console.error("[Iframe] âŒ LuckyExcel è§£æå¤±è´¥:", excelError);
                                        container.innerHTML = `<div class="loader">æ–‡ä»¶è§£æå¤±è´¥ã€‚</div>`;
                                    }
                                );
                            });
                        });
                })
                .catch(error => {
                    console.error("[Iframe] âŒ åŠ è½½æ–‡ä»¶å¤±è´¥:", error);
                    container.innerHTML = `<div class="loader">æ–‡ä»¶åŠ è½½å¤±è´¥ã€‚</div>`;
                });
        }

        /**
         * èåˆéªŒè¯è§„åˆ™
         */
        function mergeDataWithValidation(liveSheets, validationRules) {
            return liveSheets.map(liveSheet => {
                if (liveSheet && liveSheet.order != null && validationRules[liveSheet.order]) {
                    if (!liveSheet.dataVerification || Object.keys(liveSheet.dataVerification).length === 0) {
                        liveSheet.dataVerification = validationRules[liveSheet.order];
                    }
                }
                return liveSheet;
            });
        }

        /**
         * è§¦å‘æ–‡ä»¶ä¸‹è½½
         */
        function downloadBlob(blob, fileName) {
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.href = url;
            link.download = fileName;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        /**
         * å¤„ç†å¯¼å‡º
         */
        async function handleExport(fileName) {
            console.log("[Iframe] å¼€å§‹å¤ç”¨ exportWithExcelJS çš„å¯¼å‡ºæµç¨‹...");
            const loaderDiv = document.createElement('div');
            loaderDiv.className = 'loader';
            loaderDiv.style.cssText = 'position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(255, 255, 255, 0.8); z-index: 10000;';
            loaderDiv.textContent = 'æ­£åœ¨ç”ŸæˆExcelæ–‡ä»¶ï¼Œè¯·ç¨å€™...';
            container.appendChild(loaderDiv);

            try {
                const allSheetsData = luckysheet.getAllSheets();
                const blob = await exportWithExcelJS(allSheetsData);
                downloadBlob(blob, fileName);
                console.log("[Iframe] é€šè¿‡å¤ç”¨æ¨¡å—ï¼ŒæˆåŠŸå¯¼å‡ºæ–‡ä»¶ï¼");
            } catch (error) {
                console.error("[Iframe] å¤ç”¨å¯¼å‡ºæ¨¡å—æ—¶å‡ºé”™:", error);
                alert("å¯¼å‡ºæ–‡ä»¶æ—¶å‘ç”Ÿé”™è¯¯ï¼Œè¯¦æƒ…è¯·æŸ¥çœ‹æ§åˆ¶å°ã€‚");
            } finally {
                container.removeChild(loaderDiv);
            }
        }

        // --- [5. äº‹ä»¶ç›‘å¬å™¨] ---

        window.addEventListener('message', function (event) {
            if (event.origin !== window.location.origin) return;
            const { type, payload } = event.data;
            // console.log(`[Iframe] æ”¶åˆ°æ¶ˆæ¯: type=${type}`, payload);

            if (type === 'LOAD_SHEET') {
                if (payload.luckysheetData) {
                    renderSheet(payload.luckysheetData, payload.fileName, payload.options);
                } else {
                    loadSheetFromFile(payload.fileUrl, payload.fileName, payload.options);
                }
            } else if (type === 'GET_DATA_AND_IMAGES') {
                if (window.luckysheet) {
                    const liveSheets = luckysheet.getAllSheets();
                    const mergedSheets = mergeDataWithValidation(liveSheets, originalDataValidation);

                    console.log(`[Iframe] âœ… æˆåŠŸèåˆå®æ—¶æ•°æ®ã€‚å‡†å¤‡å›å‘...`);
                    window.parent.postMessage({
                        type: 'SHEET_DATA_WITH_IMAGES_RESPONSE',
                        payload: {
                            sheets: mergedSheets,
                            purpose: payload.purpose,
                            fileId: payload.fileId,
                            documentType: payload.documentType
                        }
                    }, window.location.origin);
                }
            } else if (type === 'EXPORT_SHEET') {
                if (window.luckysheet) {
                    handleExport(payload.fileName || 'å¯¼å‡ºæ–‡ä»¶.xlsx');
                }
            }
        });

        document.body.addEventListener('mousedown', () => {
            window.parent.postMessage({ type: 'IFRAME_CLICKED' }, window.location.origin);
        }, true);

        // --- [æ–°å¢åŠŸèƒ½ï¼šCtrl + æ»šè½®ç¼©æ”¾] ---
        document.addEventListener('wheel', function (event) {
            // 1. æ£€æŸ¥æ˜¯å¦æŒ‰ä½ Ctrl é”®
            if (!event.ctrlKey) return;

            // 2. é˜»æ­¢æµè§ˆå™¨é»˜è®¤çš„é¡µé¢ç¼©æ”¾
            event.preventDefault();

            // 3. å®‰å…¨æ£€æŸ¥
            if (!window.luckysheet || !window.luckysheet.getluckysheetfile) return;

            // 4. è·å–åº•å±‚æ•°æ®å¼•ç”¨
            let file = luckysheet.getluckysheetfile();
            
            // 5. æ‰¾åˆ°å½“å‰æ¿€æ´»çš„ Sheet
            let currentSheet = file.find(s => s.status === 1);
            if (!currentSheet) return;

            // 6. è®¡ç®—æ–°çš„ç¼©æ”¾æ¯”ä¾‹
            let currentRatio = currentSheet.zoomRatio || 1;
            let step = 0.1;

            if (event.deltaY < 0) {
                currentRatio += step; // å‘ä¸Šæ»šï¼Œæ”¾å¤§
            } else {
                currentRatio -= step; // å‘ä¸‹æ»šï¼Œç¼©å°
            }

            // 7. é™åˆ¶èŒƒå›´
            if (currentRatio < 0.1) currentRatio = 0.1;
            if (currentRatio > 4.0) currentRatio = 4.0;
            
            // ä¿®æ­£æµ®ç‚¹æ•°ç²¾åº¦
            currentRatio = Math.round(currentRatio * 100) / 100;

            console.log(`[Zoom] è°ƒæ•´ç¼©æ”¾: ${currentRatio}`);

            // 8. ä¿®æ”¹æ•°æ®å¹¶åˆ·æ–°
            currentSheet.zoomRatio = currentRatio;

            try {
                luckysheet.refresh();
            } catch (e) {
                console.error("[Zoom] åˆ·æ–°å¤±è´¥:", e);
            }

        }, { passive: false, capture: true }); // ä½¿ç”¨æ•è·æ¨¡å¼ç¡®ä¿æ‹¦æˆª

        console.log('[Iframe] åŠ è½½å™¨å·²å°±ç»ªï¼Œç­‰å¾…æ¶ˆæ¯...');

    </script>
</body>

</html>