<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>Luckysheet Iframe Loader</title>
    <!-- 引入所有必要的本地CSS -->
    <link rel='stylesheet' href='/luckysheet/plugins/css/pluginsCss.css' />
    <link rel='stylesheet' href='/luckysheet/css/luckysheet.css' />
    <style>
        /* 确保Luckysheet占满整个iframe */
        body, html { 
            margin: 0; 
            padding: 0; 
            overflow: hidden; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #f4f5f7;
        }
        #luckysheet-container { 
            width: 100vw; 
            height: 100vh; 
        }
        .message-box {
            color: #6c757d;
            font-size: 16px;
        }
    </style>
</head>
<body>
    <!-- 初始状态下显示一个提示信息 -->
    <div id="luckysheet-container">
        <div class="message-box">等待加载指令...</div>
    </div>

    <!-- 引入所有必要的本地JS -->
    <script src="/luckysheet/plugins/js/plugin.js"></script>
    <script src="/luckysheet/luckysheet.umd.js"></script>
    <script src="/luckysheet/luckyexcel.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script> <!-- iframe内部也需要axios -->

    <script>
        // 定义一个全局变量来持有Luckysheet实例
        let luckysheetInstance = null;

        // 封装销毁逻辑
        function destroyInstance() {
            if (luckysheet.destroy) { // 健壮性检查
                try {
                    luckysheet.destroy(); // 新版API可能不需要传实例
                    console.log('%c[Iframe] Luckysheet instance destroyed.', 'color: orange;');
                } catch(e) {
                    console.error("[Iframe] 销毁实例时出错:", e);
                }
            }
            // 清空容器，确保万无一失
            document.getElementById('luckysheet-container').innerHTML = ''; 
        }

        // 封装创建逻辑
        function createInstance(options, exportJson) {
            destroyInstance(); // 创建前先销毁旧的
            const finalOptions = {
                container: 'luckysheet-container',
                ...options,
                data: exportJson.sheets,
                title: exportJson.info.name
            };
            console.log('%c[Iframe] 准备使用以下配置创建Luckysheet:', 'color: blue;', finalOptions);
            luckysheet.create(finalOptions);
            // Luckysheet创建后，实例会挂载在全局
        }
        
        // 封装显示错误信息的逻辑
        function displayError(message) {
            const container = document.getElementById('luckysheet-container');
            container.innerHTML = `<div class="message-box"><strong>错误:</strong> ${message}</div>`;
        }

        // 主消息监听器
        window.addEventListener('message', function(event) {
            // 安全性检查：生产环境中建议替换为你的实际域名
            // if (event.origin !== 'http://localhost:8081') return;
            
            if (!event.data || !event.data.type) return;

            const { type, payload } = event.data;

            console.log(`%c[Iframe] 收到一条消息!`, 'color: purple; font-weight: bold;', { type, payload });

            if (type === 'LOAD_SHEET_FROM_URL') {
                if (!payload || !payload.fileUrl || !payload.options) {
                    displayError('收到的加载指令格式不正确 (LOAD_SHEET_FROM_URL)');
                    return;
                }
                
                const { fileUrl, options } = payload;
                const container = document.getElementById('luckysheet-container');
                container.innerHTML = `<div class="message-box">指令已收到，正在从 ${fileUrl} 加载文件...</div>`;
                
                console.log(`[Iframe] 准备使用 axios.get 请求文件: ${fileUrl}`);

                axios.get(fileUrl, { responseType: 'blob' })
                    .then(response => {
                        console.log(`%c[Iframe] 文件 ${fileUrl} 下载成功！准备用 LuckyExcel 解析...`, 'color: green; font-weight: bold;');
                        
                        LuckyExcel.transformExcelToLucky(response.data, 
                            (exportJson) => {
                                console.log(`%c[Iframe] LuckyExcel 解析成功！准备创建 Luckysheet...`, 'color: green; font-weight: bold;');
                                if (!exportJson.sheets || exportJson.sheets.length === 0) {
                                    displayError('文件内容为空或无法解析。');
                                    window.parent.postMessage({ type: 'SHEET_LOAD_ERROR', payload: { error: '文件内容为空' } }, event.origin);
                                    return;
                                }
                                createInstance(options, exportJson);
                                console.log(`%c[Iframe] Luckysheet 渲染完成！`, 'color: green; font-weight: bold;');
                            },
                            (error) => {
                                console.error(`%c[Iframe] LuckyExcel 解析失败！`, 'color: red; font-weight: bold;', error);
                                displayError('使用LuckyExcel转换文件时出错。');
                                window.parent.postMessage({ type: 'SHEET_LOAD_ERROR', payload: { error: error } }, event.origin);
                            }
                        );
                    }).catch(error => {
                        const status = error.response ? error.response.status : 'N/A';
                        console.error(`%c[Iframe] axios.get 请求 ${fileUrl} 失败！状态码: ${status}`, 'color: red; font-weight: bold;', error);
                        displayError(`从服务器获取文件失败。状态码: ${status}`);
                        window.parent.postMessage({ type: 'SHEET_LOAD_ERROR', payload: { error: `获取文件失败: ${status}` } }, event.origin);
                    });

            } else if (type === 'LOAD_SHEET_FROM_DATA') {
                console.log('[Iframe] 开始直接从JSON数据渲染...');
                if (!payload || !payload.jsonData || !payload.options) {
                    displayError('收到的加载指令格式不正确 (LOAD_SHEET_FROM_DATA)');
                    return;
                }
                try {
                    createInstance(payload.options, payload.jsonData);
                    console.log('%c[Iframe] 从JSON数据渲染成功！', 'color: green; font-weight: bold;');
                } catch (e) {
                     displayError('渲染已加载的数据时出错。');
                     window.parent.postMessage({ type: 'SHEET_LOAD_ERROR', payload: { error: e.message } }, event.origin);
                }

            } else if (type === 'GET_DATA') {
                if (window.luckysheet) {
                    const allSheetsData = window.luckysheet.getAllSheets();
                    console.log('%c[Iframe] 准备将数据发送回父窗口:', 'color: blue;', allSheetsData);
                    event.source.postMessage({ type: 'SHEET_DATA_RESPONSE', payload: allSheetsData }, event.origin);
                } else {
                     console.warn("[Iframe] 收到 GET_DATA 指令，但Luckysheet未初始化。");
                }
                
            } else if (type === 'DESTROY') {
                destroyInstance();
            }
        });
    </script>
</body>
</html>