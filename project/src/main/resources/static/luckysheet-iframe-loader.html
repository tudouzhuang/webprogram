<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <title>Luckysheet Iframe Loader</title>
    <link rel='stylesheet' href='/luckysheet/plugins/css/pluginsCss.css' />
    <link rel='stylesheet' href='/luckysheet/plugins/plugins.css' />
    <link rel='stylesheet' href='/luckysheet/css/luckysheet.css' />
    <link rel='stylesheet' href='/luckysheet/assets/iconfont/iconfont.css' />
    <style>
        html,
        body,
        #luckysheet-container {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        .loader {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            font-size: 1.1em;
            color: #888;
            text-align: center;
            padding: 10px;
        }
    </style>
</head>

<body>
    <div id="luckysheet-container">
        <div class="loader">ç­‰å¾…çˆ¶çª—å£æŒ‡ä»¤...</div>
    </div>

    <script src="/luckysheet/plugins/js/plugin.js"></script>
    <script src="/luckysheet/luckysheet.umd.js"></script>
    <script src="/luckysheet/luckyexcel.umd.js"></script>
    <script src="/js/libs/exceljs.min.js"></script>

    <script type="module">
        // --- [0. å…¨å±€å¼‚å¸¸ç†”æ–­ (å¢å¼ºç‰ˆ)] ---
        // æ•è· Promise ä¹Ÿå°±æ˜¯ Luckysheet å†…éƒ¨æŠ›å‡ºçš„è‡´å‘½å¼‚æ­¥é”™è¯¯
        window.addEventListener('unhandledrejection', function (event) {
            console.error("[Iframe] âš ï¸ æ•è·åˆ°æœªå¤„ç†çš„ Promise å¼‚å¸¸:", event.reason);

            const reason = event.reason || {};
            const message = (reason.message || reason.toString() || "").toLowerCase();
            const name = reason.name || "";

            // å®šä¹‰è‡´å‘½é”™è¯¯çš„ç‰¹å¾ï¼š
            // 1. å­—ä½“è§£æé”™è¯¯ (SyntaxError: FontFaceSet...)
            // 2. å†…éƒ¨è®¡ç®—å´©æºƒ (TypeError: Cannot read properties...) -> ä½ é‡åˆ°çš„è¿™ä¸ª
            if (
                name === 'SyntaxError' ||
                name === 'TypeError' ||
                message.includes('fontfaceset') ||
                message.includes('could not resolve') ||
                message.includes('cannot read properties') || // ğŸ‘ˆ é’ˆå¯¹æœ¬æ¬¡æŠ¥é”™
                message.includes('reading')                   // ğŸ‘ˆ é’ˆå¯¹æœ¬æ¬¡æŠ¥é”™
            ) {
                // ç«‹å³æ˜¾ç¤ºé”™è¯¯é¡µ
                const container = document.getElementById('luckysheet-container');
                if (container) {
                    let userFriendlyMsg = "æ¸²æŸ“å¼•æ“å†…éƒ¨é€»è¾‘å´©æºƒ";

                    if (message.includes('font')) {
                        userFriendlyMsg = "æµè§ˆå™¨æ— æ³•åº”ç”¨å­—ä½“è®¾ç½®";
                    } else if (message.includes('cannot read') || message.includes('reading')) {
                        userFriendlyMsg = "è¡¨æ ¼ç»“æ„è¿‡å¤æ‚æˆ–å«éæ³•åˆå¹¶å•å…ƒæ ¼ï¼Œè®¡ç®—å¤±è´¥";
                    }

                    container.innerHTML = `
                        <div style="display:flex;flex-direction:column;justify-content:center;align-items:center;height:100%;background:#fff2f0;color:#cf1322;padding:20px;text-align:center;">
                            <h3 style="margin-bottom:10px;font-size:18px;">âŒ æ–‡ä»¶è§£æå¼‚å¸¸</h3>
                            <p style="font-size:14px;color:#666;">${userFriendlyMsg}</p>
                            <p style="font-size:12px;color:#999;margin-top:5px;">Technical Info: ${message.slice(0, 50)}...</p>
                        </div>
                    `;
                }

                // é€šçŸ¥çˆ¶çª—å£åœæ­¢ Loading
                window.parent.postMessage({
                    type: 'LUCKYSHEET_RENDER_FINISHED',
                    status: 'error',
                    message: "æ¸²æŸ“å´©æºƒ: " + (reason.message || "æœªçŸ¥å†…éƒ¨é”™è¯¯")
                }, window.location.origin);
            }
        });
        // --- [1. å¯¼å…¥å¤–éƒ¨æ¨¡å—] ---
        import { exportWithExcelJS } from '/js/utils/luckysheetExporter.js';

        // --- [2. å…¨å±€å˜é‡ä¸çŠ¶æ€] ---
        const container = document.getElementById('luckysheet-container');
        let originalDataValidation = {};
        let originalRowlen = {};

        // --- [3. è¾…åŠ©å‡½æ•°å®šä¹‰] ---

        /**
         * æ¢å¤è¡Œé«˜å‡½æ•°
         */
        function restoreRowHeight(startRow, rowCount) {
            // ç¡®ä¿ luckysheet å®ä¾‹å­˜åœ¨
            if (!window.luckysheet) return;

            for (let i = 0; i < rowCount; i++) {
                const rowIndex = String(startRow + i);
                const originalHeight = originalRowlen[rowIndex];

                if (originalHeight !== undefined) {
                    const currentHeight = luckysheet.getRowHeight([parseInt(rowIndex)])[rowIndex];

                    if (currentHeight !== originalHeight) {
                        console.log(`[Row Height Fix] æ£€æµ‹åˆ°è¡Œ ${parseInt(rowIndex) + 1} é«˜åº¦è¢«è‡ªåŠ¨ä¿®æ”¹ï¼Œæ­£åœ¨ä» ${currentHeight} æ¢å¤è‡³ ${originalHeight}`);
                        luckysheet.setRowHeight({ [rowIndex]: originalHeight });
                    }
                }
            }
        }

        /**
         * Debounce é˜²æŠ–å‡½æ•°
         */
        function debounce(func, wait) {
            let timeout;
            return function (...args) {
                const context = this;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), wait);
            };
        }

        /**
         * æ ¸å¿ƒç»Ÿè®¡ä¸æ±‡æŠ¥å‡½æ•°
         */
        function calculateAndReportStats() {
            if (!window.luckysheet) return; // å®‰å…¨æ£€æŸ¥
            // console.log('[Iframe] å˜æ›´å·²è§¦å‘ï¼Œå‡†å¤‡æ‰§è¡Œç»Ÿè®¡...');

            const rules = [
                { category: 'å†…å®¡è‡ªæ£€', range: 'G10:G50', ok: 'âˆš', ng: 'Ã—', na: 'æ— ' },
                { category: 'FMCè‡ªæ£€', range: 'H10:H50', ok: 'âˆš', ng: 'Ã—', na: 'æ— ' }
            ];
            const statsResult = {};

            rules.forEach(rule => {
                try {
                    const rangeData = luckysheet.getRangeArray(rule.range);
                    let okCount = 0, ngCount = 0, naCount = 0;

                    rangeData.forEach(row => {
                        row.forEach(cellValue => {
                            if (cellValue) {
                                if (cellValue === rule.ok) okCount++;
                                else if (cellValue === rule.ng) ngCount++;
                                else if (cellValue === rule.na) naCount++;
                            }
                        });
                    });

                    const totalCount = okCount + ngCount + naCount;
                    const okPercentage = totalCount > 0 ? Math.round((okCount / totalCount) * 10000) / 100 : 0;

                    statsResult[rule.category] = {
                        category: rule.category, okCount, ngCount, naCount, totalCount, okPercentage
                    };
                } catch (e) {
                    console.error(`[Iframe] ç»Ÿè®¡è§„åˆ™ "${rule.category}" æ‰§è¡Œå¤±è´¥:`, e);
                }
            });

            // console.log('[Iframe] ç»Ÿè®¡è®¡ç®—å®Œæˆï¼Œç»“æœ:', statsResult);

            window.parent.postMessage({
                type: 'STATS_UPDATE',
                payload: statsResult
            }, window.location.origin);
        }

        /**
         * è‡ªåŠ¨æ ‡çº¢å‡½æ•°
         */
        function autoHighlightCell(r, c, cell) {
            // ã€æ¢å¤´ Aã€‘: ç¡®è®¤å‡½æ•°æ˜¯å¦è¢«è°ƒç”¨
            // console.log(`[Highlight-Debug] autoHighlightCell è¢«è°ƒç”¨ï¼åæ ‡: (r=${r}, c=${c})`);

            if (!window.luckysheet || !cell) {
                // console.log('[Highlight-Debug] Luckysheet å®ä¾‹æˆ– cell å¯¹è±¡ä¸ºç©ºï¼Œå·²ç»ˆæ­¢ã€‚');
                return;
            }

            const cellValue = cell.v ? String(cell.v).trim() : '';
            const targetColumns = [4, 5, 6, 7, 8, 9, 10]; // E=4, F=5, ..., K=10

            // ã€æ¢å¤´ Cã€‘: ç¡®è®¤åˆ—åæ ‡æ˜¯å¦åœ¨ç›®æ ‡èŒƒå›´å†…
            if (targetColumns.includes(c)) {
                if (cellValue === 'Ã—') {
                    // ã€æ¢å¤´ D-1ã€‘: ç¡®è®¤æ˜¯å¦åŒ¹é… "Ã—"
                    luckysheet.setCellFormat(r, c, 'bg', '#ffdddd');
                    luckysheet.setCellFormat(r, c, 'fc', '#9c0006');
                } else {
                    // ã€æ¢å¤´ D-2ã€‘: ç¡®è®¤æ˜¯å¦è¿›å…¥â€œæ¸…é™¤é¢œè‰²â€çš„é€»è¾‘
                    if (cell.bg === '#ffdddd') {
                        luckysheet.setCellFormat(r, c, 'bg', null);
                        luckysheet.setCellFormat(r, c, 'fc', null);
                    }
                }
            }
        }

        /**
         * åˆ›å»ºé˜²æŠ–å‡½æ•°çš„å®ä¾‹ï¼Œå»¶è¿Ÿ500msæ‰§è¡Œã€‚
         */
        const debouncedCalculate = debounce(calculateAndReportStats, 500);

        // --- [4. æ ¸å¿ƒåŠŸèƒ½å‡½æ•°] ---

        /**
                 * æ¸²æŸ“ Luckysheet å®ä¾‹ (ç»ˆæä¿®å¤ç‰ˆï¼šé˜²å´©æºƒ + æ•°æ®æ¸…æ´— + ç§»é™¤æ— æ•ˆä¾èµ–)
                 */
        function renderSheet(luckysheetData, fileName, options) {
            if (window.luckysheet) {
                try {
                    window.onresize = null; // ğŸ‘ˆ æ‰‹æœ¯åˆ€ï¼šå¼ºåˆ¶åˆ‡æ–­å…¨å±€ resize ç›‘å¬ï¼Œé˜²æ­¢æ—§ resize.js è¿è¡Œ
                    luckysheet.destroy();
                } catch (e) {
                    console.warn("é”€æ¯æ—§å®ä¾‹æ—¶å‡ºç°éè‡´å‘½é”™è¯¯:", e);
                }
            }
            // æ¸…ç©ºå®¹å™¨ï¼Œç¡®ä¿å¹²å‡€çš„ DOM ç¯å¢ƒ
            document.getElementById('luckysheet-container').innerHTML = '';

            // --- [æ•°æ®é˜²å¾¡æ€§å¤„ç†] ---
            let validData = luckysheetData;

            // 1. å¦‚æœæ•°æ®ä¸ºç©ºæˆ–éæ•°ç»„ï¼Œåˆå§‹åŒ–é»˜è®¤é¡µ
            if (!Array.isArray(validData) || validData.length === 0) {
                console.warn("[Iframe] æ•°æ®æºä¸ºç©ºï¼Œåˆå§‹åŒ–ä¸ºé»˜è®¤ Sheet1ã€‚");
                validData = [{
                    name: "Sheet1",
                    status: 1,
                    order: 0,
                    row: 30,
                    column: 20,
                    celldata: [],
                    config: {}
                }];
            } else {
                // æ·±æ‹·è´ï¼Œé˜²æ­¢ä¿®æ”¹å½±å“åŸå§‹æ•°æ®å¯¹è±¡
                try {
                    validData = JSON.parse(JSON.stringify(validData));
                } catch (e) {
                    console.error("æ•°æ®æ·±æ‹·è´å¤±è´¥:", e);
                }
            }

            // ============================================================
            // ğŸ”¥ğŸ”¥ğŸ”¥ã€å…³é”®ä¿®å¤ï¼šæ•°æ®æ¸…æ´—ã€‘é˜²æ­¢ mergeCalculation å´©æºƒ ğŸ”¥ğŸ”¥ğŸ”¥
            // ============================================================
            validData.forEach((sheet, index) => {
                // A. è¡¥å…¨å¿…è¦å­—æ®µï¼Œé˜²æ­¢ undefined æŠ¥é”™
                const rowCount = Math.max(sheet.row || 0, 30); // é»˜è®¤è‡³å°‘30è¡Œ
                const colCount = Math.max(sheet.column || 0, 20); // é»˜è®¤è‡³å°‘20åˆ—

                // 1. ç¡®ä¿ data äºŒç»´æ•°ç»„å­˜åœ¨ä¸”è¡Œæ•°è¶³å¤Ÿ
                if (!sheet.data || sheet.data.length === 0) {
                    // å¦‚æœæ²¡æœ‰ data ä½†æœ‰ celldataï¼ŒLuckysheet ä¼šå¤„ç†ï¼Œä½†ä¸ºäº†å®‰å…¨æˆ‘ä»¬åˆå§‹åŒ–å®ƒ
                    sheet.data = Array.from({ length: rowCount }, () => Array(colCount).fill(null));
                } else if (sheet.data.length < rowCount) {
                    // ğŸ‘ˆ å…³é”®ä¿®å¤ï¼šè¡¥é½ç¼ºå¤±çš„è¡Œï¼Œé˜²æ­¢ mergeCalculation è¯»å– undefined[15]
                    for (let i = sheet.data.length; i < rowCount; i++) {
                        sheet.data[i] = new Array(colCount).fill(null);
                    }
                }
                delete sheet.calcChain;
                if (!sheet.celldata) sheet.celldata = [];
                if (!sheet.config) sheet.config = {};


                if (!sheet.config.borderInfo) sheet.config.borderInfo = [];

                // ç”¨äºåŠ¨æ€æ‰©å®¹ï¼Œé˜²æ­¢è¾¹æ¡†ç”»åœ¨è¡¨æ ¼å¤–é¢è¢«æˆªæ–­
                let patchMaxRow = sheet.row || 30;
                let patchMaxCol = sheet.column || 20;

                // --- [A] è¾¹æ¡†ä¿®å¤ (æ™ºèƒ½ Range æ¨¡å¼ï¼šæ”¯æŒåˆå¹¶å•å…ƒæ ¼) ---
                if (sheet.celldata && Array.isArray(sheet.celldata)) {
                    sheet.celldata.forEach(cell => {
                        const r = cell.r;
                        const c = cell.c;

                        // 1. æ‰©å®¹æ¢æµ‹
                        if (r >= patchMaxRow) patchMaxRow = r + 5;
                        if (c >= patchMaxCol) patchMaxCol = c + 2;

                        // 2. è¾¹æ¡†æå–
                        if (cell.v && cell.v.bd) {
                            const bd = cell.v.bd;

                            // ğŸ”¥ å…³é”®ç‚¹1ï¼šæ£€æŸ¥æ˜¯å¦ä¸ºåˆå¹¶å•å…ƒæ ¼
                            // å¦‚æœæ˜¯åˆå¹¶å•å…ƒæ ¼ï¼Œæˆ‘ä»¬éœ€è¦è·å–å®ƒçš„è·¨åº¦(rs, cs)ï¼Œå¦åˆ™é»˜è®¤ä¸º1x1
                            let rs = 1;
                            let cs = 1;
                            const mergeKey = `${r}_${c}`;
                            if (sheet.config.merge && sheet.config.merge[mergeKey]) {
                                rs = sheet.config.merge[mergeKey].rs;
                                cs = sheet.config.merge[mergeKey].cs;
                            }

                            // ğŸ”¥ å…³é”®ç‚¹2ï¼šæ„å»ºèŒƒå›´ (Range)
                            // å³ä½¿æ˜¯å•å•å…ƒæ ¼ï¼Œä¹Ÿå½“ä½œä¸€ä¸ª 1x1 çš„èŒƒå›´æ¥å¤„ç†ï¼Œè¿™æ ·é€»è¾‘æœ€ç»Ÿä¸€ä¸”å…¼å®¹åˆå¹¶
                            const range = {
                                "row": [r, r + rs - 1],
                                "column": [c, c + cs - 1]
                            };

                            // è¾…åŠ©å‡½æ•°ï¼šä½¿ç”¨ rangeType: 'range' æ¨é€è¾¹æ¡†
                            // Range æ¨¡å¼æ˜¯â€œå åŠ â€çš„ï¼Œä¸ä¼šåƒ Cell æ¨¡å¼é‚£æ ·äº’ç›¸è¦†ç›–ï¼Œæ‰€ä»¥å¯ä»¥æ”¾å¿ƒåˆ†å››æ¬¡æ¨
                            const pushRangeBorder = (borderType, styleObj) => {
                                if (styleObj && (styleObj.style || styleObj.style === 0)) {
                                    sheet.config.borderInfo.push({
                                        "rangeType": "range",
                                        "borderType": borderType,
                                        "style": parseInt(styleObj.style),
                                        "color": styleObj.color || "#000000",
                                        "range": [range]
                                    });
                                }
                            };

                            // åˆ†åˆ«æ¨é€å››è¾¹
                            if (bd.t) pushRangeBorder("border-top", bd.t);
                            if (bd.b) pushRangeBorder("border-bottom", bd.b);
                            if (bd.l) pushRangeBorder("border-left", bd.l);
                            if (bd.r) pushRangeBorder("border-right", bd.r);
                        }
                    });
                }

                // 3. åº”ç”¨æ‰©å®¹ (è¿™ä¸€æ­¥éå¸¸å…³é”®ï¼Œå¦åˆ™ç¬¬30è¡Œä¹‹åçš„è¾¹æ¡†ä¼šè¢«åˆ‡æ‰)
                sheet.row = Math.max(sheet.row || 0, patchMaxRow);
                sheet.column = Math.max(sheet.column || 0, patchMaxCol);




                if (sheet.zoomRatio == null) sheet.zoomRatio = 1;

                // B. ã€å¿…åˆ ã€‘æš´åŠ›åˆ é™¤ calcChain (è®¡ç®—é“¾)
                // Excel å¯¼å…¥çš„è®¡ç®—é“¾å¾€å¾€ä¸å½“å‰æ•°æ®ä¸åŒ¹é…ï¼Œæ˜¯å¯¼è‡´ "reading '2'" å´©æºƒçš„å…ƒå‡¶
                if (sheet.calcChain) {
                    console.warn(`[Loader] ğŸ›¡ï¸ å·²ç§»é™¤ Sheet "${sheet.name}" çš„ calcChain ä»¥é˜²æ­¢å…¬å¼è®¡ç®—å´©æºƒã€‚`);
                    delete sheet.calcChain;
                }

                if (sheet.config && sheet.config.merge) {
                    const actualRows = sheet.data ? sheet.data.length : (sheet.row || 0);
                    Object.keys(sheet.config.merge).forEach(key => {
                        const m = sheet.config.merge[key];
                        // ğŸ‘ˆ æ‰‹æœ¯åˆ€ï¼šå¦‚æœåˆå¹¶å•å…ƒæ ¼çš„èµ·å§‹è¡Œ(r)å·²ç»è¶…è¿‡äº†å®é™… data çš„è¡Œæ•°ï¼Œç›´æ¥åˆ‡é™¤
                        if (!m || m.r === undefined || m.r >= actualRows) {
                            delete sheet.config.merge[key];
                        }
                    });
                }
            });

            // 2. ç¡®ä¿å¿…ç„¶æœ‰ä¸€ä¸ªæ¿€æ´»çš„ Sheet (status: 1)
            let hasActive = false;
            validData.forEach(sheet => {
                if (sheet.status === 1) hasActive = true;
            });

            if (!hasActive) {
                console.warn("[Iframe] æœªæ£€æµ‹åˆ°æ¿€æ´»çš„ Sheetï¼Œå¼ºåˆ¶æ¿€æ´»ç¬¬ 0 ä¸ªã€‚");
                if (validData[0]) validData[0].status = 1;
            }

            // æ­¥éª¤ 2: å¤‡ä»½åŸå§‹æ•°æ® (ç”¨äºåç»­å¯¹æ¯”æˆ–å¯¼å‡º)
            originalDataValidation = {}; // ç¡®ä¿å…¨å±€å˜é‡å­˜åœ¨
            validData.forEach(sheet => {
                if (sheet && sheet.order != null && sheet.dataVerification) {
                    originalDataValidation[sheet.order] = sheet.dataVerification;
                }
            });

            // å¤‡ä»½åŸå§‹è¡Œé«˜ (ç”¨äº hack ä¿®å¤è¡Œé«˜é—®é¢˜)
            if (validData[0] && validData[0].config && validData[0].config.rowlen) {
                // originalRowlen éœ€è¦æ˜¯å…¨å±€å˜é‡
                window.originalRowlen = { ...validData[0].config.rowlen };
                console.log("[Iframe] åŸå§‹è¡Œé«˜å·²å¤‡ä»½ã€‚");
            } else {
                window.originalRowlen = {};
            }

            // æ­¥éª¤ 3: ç»„è£…é…ç½®å¯¹è±¡
            const finalOptions = {
                container: 'luckysheet-container', // å®¹å™¨ ID
                data: validData,
                title: fileName,
                lang: 'zh', // å¼ºåˆ¶ä¸­æ–‡

                // --- ã€UI ä¸ å­—ä½“é…ç½®ã€‘ ---
                defaultFontSize: 14, // ä¿®å¤ '12px default' æŠ¥é”™
                limitSheetNameLength: false, // å…è®¸é•¿æ–‡ä»¶å
                fontList: [
                    { "fontName": "å¾®è½¯é›…é»‘", "url": "" },
                    { "fontName": "å®‹ä½“", "url": "" },
                    { "fontName": "Arial", "url": "" },
                    { "fontName": "Times New Roman", "url": "" }
                ],

                // æ˜¾å¼å¼€å¯æ‰€æœ‰åŠŸèƒ½ï¼Œé˜²æ­¢è¢« options è¦†ç›–
                showinfobar: false, // éšè—é¡¶éƒ¨ä¿¡æ¯æ 
                allowUpdate: true,
                enableAddRow: true,
                enableAddBackTop: true,

                // åˆå¹¶ä¼ å…¥çš„è‡ªå®šä¹‰é€‰é¡¹
                ...options
            };

            requestAnimationFrame(() => { // ğŸ‘ˆ æ‰‹æœ¯åˆ€ï¼šç¡®ä¿åœ¨ä¸‹ä¸€å¸§æ¸²æŸ“æ—¶æ‰§è¡Œï¼Œæ­¤æ—¶ DOM offsetHeight å¿…ç„¶å­˜åœ¨
                try {
                    console.log(`[Iframe] å‡†å¤‡åˆ›å»º Luckysheet å®ä¾‹...`);
                    if (window.luckysheet) {
                        window.luckysheet.refreshMenu = function () { }; // ä¸´æ—¶å±è”½å¯èƒ½å¯¼è‡´å¼‚æ­¥æŠ¥é”™çš„èœå•åˆ·æ–°
                    }
                    window.luckysheet.create(finalOptions);
                } catch (createError) {
                    console.error("ğŸ”¥ åˆ›å»º Luckysheet å®ä¾‹å¤±è´¥:", createError);
                }
            });

            // æ­¥éª¤ 5: å»¶è¿Ÿæ‰§è¡Œ Refresh å’Œ Hook
            // ä½¿ç”¨ setTimeout ç¡®ä¿ Luckysheet DOM å·²ç»æ¸²æŸ“å®Œæ¯•
            setTimeout(() => {
                try {
                    // 1. åŸºç¡€å®‰å…¨æ£€æŸ¥
                    if (!window.luckysheet) return;

                    const sheets = luckysheet.getluckysheetfile();
                    // æ£€æŸ¥å†…éƒ¨æ•°æ®ç»“æ„æ˜¯å¦çœŸçš„è½¬æ¢æˆäº† flowdata
                    if (!sheets || sheets.length === 0 || !sheets[0].data) {
                        console.warn("[Iframe] æ¸²æŸ“æœªå°±ç»ª (flowdata ç¼ºå¤±)ï¼Œè·³è¿‡é…ç½®");
                        return;
                    }

                    // 2. å…¨å±€é…ç½®ä¸çŠ¶æ€ä¿®æ­£
                    luckysheet.luckysheetautofixrowlen = false; // ç¦æ­¢è‡ªåŠ¨è¡Œé«˜ï¼Œé˜²æ­¢å¸ƒå±€æŠ–åŠ¨

                    // 3. æ‰§è¡Œåˆ·æ–° (æ‰‹æœ¯åˆ€ï¼šåŒé‡æ£€æŸ¥å®¹å™¨é«˜åº¦ï¼Œé˜²æ­¢ resize.js æŠ¥ offsetHeight ä¸º null)
                    const containerEl = document.getElementById('luckysheet-container');
                    if (containerEl && containerEl.offsetHeight > 0) {
                        try {
                            luckysheet.refresh();
                            console.log("[Iframe] Luckysheet åˆ·æ–°æˆåŠŸ");
                        } catch (resErr) {
                            console.warn("[Iframe] åˆ·æ–°è¿‡ç¨‹å‡ºç°éè‡´å‘½å¼‚å¸¸:", resErr.message);
                        }
                    }

                    // 4. è®¾ç½® Hooks (ç¡®ä¿ä¸é‡å¤æ³¨å†Œ)
                    if (!luckysheet.hooks) {
                        luckysheet.hooks = {};
                    }

                    // æ³¨å†Œå•å…ƒæ ¼æ›´æ–°é’©å­
                    luckysheet.hooks.cellUpdated = function (r, c, r_len, c_len) {
                        try {
                            const allSheets = luckysheet.getAllSheets();
                            const currentSheet = allSheets.find(s => s.status === 1) || allSheets[0];

                            if (currentSheet && currentSheet.data && currentSheet.data[r] && currentSheet.data[r][c]) {
                                const cell = currentSheet.data[r][c];
                                // æ‰§è¡Œä¸šåŠ¡é€»è¾‘
                                if (typeof autoHighlightCell === 'function') autoHighlightCell(r, c, cell);
                                if (typeof debouncedCalculate === 'function') debouncedCalculate();
                            }
                        } catch (hookError) {
                            console.error("[Hook Error] å•å…ƒæ ¼æ›´æ–°å¤„ç†å‡ºé”™:", hookError);
                        }
                    };

                    console.log("[Iframe] Hooks æ³¨å†Œå®Œæˆ");

                    // 5. ä»»åŠ¡æ”¶å°¾ï¼šé€šçŸ¥çˆ¶çª—å£å¹¶é‡Šæ”¾æ¸²æŸ“é”
                    if (window.parent) {
                        window.parent.postMessage({
                            type: 'LUCKYSHEET_RENDER_FINISHED',
                            status: 'success'
                        }, '*');
                    }

                } catch (e) {
                    console.error(`[Iframe] å»¶è¿Ÿé…ç½®é˜¶æ®µè‡´å‘½å¤±è´¥:`, e);
                } finally {
                    // å¦‚æœä½ ä¹‹å‰è®¾ç½®äº† isRendering é”ï¼Œåœ¨è¿™é‡Œé‡Šæ”¾å®ƒ
                    if (typeof isRendering !== 'undefined') {
                        isRendering = false;
                    }
                }
            }, 500); // ğŸ‘ˆ æ‰‹æœ¯å…³é”®ï¼šç¡®ä¿ 500ms ä¸”æ‹¬å·é—­åˆæ­£ç¡®
        }

        /**
         * ä»æ–‡ä»¶URLåŠ è½½æ•°æ®
         */
        function loadSheetFromFile(fileUrl, fileName, options) {
            container.innerHTML = `<div class="loader">æ­£åœ¨åŠ è½½æ•°æ®...</div>`;

            fetch(fileUrl)
                .then(response => {
                    if (!response.ok) throw new Error(`ç½‘ç»œé”™è¯¯: ${response.statusText}`);
                    const clonedResponse = response.clone();

                    return response.json()
                        .then(jsonData => {
                            console.log("[Iframe] âœ… æˆåŠŸå°†å“åº”è§£æä¸ºJSONï¼");
                            // å…¼å®¹ç›´æ¥æ˜¯æ•°ç»„æˆ–å¯¹è±¡åŒ…å« sheets çš„æƒ…å†µ
                            const dataToRender = Array.isArray(jsonData) ? jsonData : (jsonData.sheets || []);
                            renderSheet(dataToRender, fileName, options);
                        })
                        // ... å‰é¢çš„ fetch(...).then(...).then(...) ä¿æŒä¸å˜

                        .catch(jsonError => {
                            console.warn("[Iframe] âš ï¸ è§£æä¸ºJSONå¤±è´¥ï¼Œå›é€€åˆ°äºŒè¿›åˆ¶æ–‡ä»¶å¤„ç†æ¨¡å¼ã€‚");
                            container.innerHTML = `<div class="loader">æ­£åœ¨ä½¿ç”¨å¤‡ç”¨æ¨¡å¼è§£ææ–‡ä»¶...</div>`;

                            // 1. è·å– Blob æ•°æ®
                            return clonedResponse.blob().then(fileBlob => {

                                // ğŸ”¥ğŸ”¥ğŸ”¥ã€æ’å…¥ä¾¦æ¢ä»£ç å¼€å§‹ã€‘ğŸ”¥ğŸ”¥ğŸ”¥
                                console.log("ğŸ” [ä¾¦æ¢] å‡†å¤‡äº¤ç»™ LuckyExcel çš„æ–‡ä»¶ä¿¡æ¯ï¼š");
                                console.log("   - å¤§å°:", fileBlob.size, "å­—èŠ‚");
                                console.log("   - ç±»å‹:", fileBlob.type);

                                // å¦‚æœæ–‡ä»¶å°äº 1KBï¼Œææœ‰å¯èƒ½ä¸æ˜¯ Excelï¼Œè€Œæ˜¯åç«¯æŠ¥é”™æ–‡æœ¬
                                if (fileBlob.size < 1000) {
                                    const reader = new FileReader();
                                    reader.onload = function () {
                                        console.error("ğŸ’€ [ä¾¦æ¢] æ–‡ä»¶å¤ªå°ï¼Œç–‘ä¼¼æŠ¥é”™æ–‡æœ¬ï¼Œå†…å®¹å¦‚ä¸‹:", this.result);
                                    }
                                    reader.readAsText(fileBlob);
                                }

                                // ğŸ”¥ğŸ”¥ğŸ”¥ã€æ’å…¥ä¾¦æ¢ä»£ç ç»“æŸã€‘ğŸ”¥ğŸ”¥ğŸ”¥
                                // 2. å®šä¹‰è¶…æ—¶ç«é€Ÿ Promise (1000ç§’)
                                const timeoutPromise = new Promise((_, reject) => {
                                    setTimeout(() => {
                                        reject(new Error('TIMEOUT'));
                                    }, 1000000);
                                });

                                // 3. å®šä¹‰è§£æ Promise (åŒ…è£¹ LuckyExcel)
                                const parsingPromise = new Promise((resolve, reject) => {
                                    try {
                                        LuckyExcel.transformExcelToLucky(fileBlob,
                                            function (exportJson, luckysheetfile) {

                                                // ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ [è°ƒè¯•æ¢é’ˆ START] ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥
                                                console.group("%cğŸ” [Import Debug] å¼€å§‹æ£€æŸ¥è¯»å–åˆ°çš„ Excel æ–‡ä»¶", "color: red; font-size: 14px; font-weight: bold;");

                                                if (exportJson.sheets && exportJson.sheets.length > 0) {
                                                    exportJson.sheets.forEach((sheet, index) => {
                                                        console.log(`ğŸ“„ Sheet [${index}] åç§°: ${sheet.name}`);

                                                        // æ£€æŸ¥ dataVerification å­—æ®µ
                                                        if (sheet.dataVerification) {
                                                            const rules = Object.keys(sheet.dataVerification);
                                                            if (rules.length > 0) {
                                                                console.log(`   âœ… å‘ç° ${rules.length} æ¡éªŒè¯è§„åˆ™:`, sheet.dataVerification);
                                                            } else {
                                                                console.warn(`   âš ï¸ dataVerification å¯¹è±¡å­˜åœ¨ï¼Œä½†æ˜¯æ˜¯ç©ºçš„ (Empty Object)`);
                                                            }
                                                        } else {
                                                            console.error(`   âŒ è¯¥ Sheet å®Œå…¨æ²¡æœ‰ dataVerification å­—æ®µï¼`);
                                                        }
                                                    });
                                                } else {
                                                    console.error("âŒ è§£æç»“æœä¸­æ²¡æœ‰æ‰¾åˆ° sheetsï¼");
                                                }
                                                console.groupEnd();
                                                // ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ [è°ƒè¯•æ¢é’ˆ END] ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥

                                                if (exportJson.sheets == null || exportJson.sheets.length == 0) {
                                                    reject(new Error('EMPTY_CONTENT'));
                                                } else {
                                                    resolve(exportJson);
                                                }
                                            },
                                            function (err) {
                                                console.error("LuckyExcel internal error:", err);
                                                reject(new Error('PARSE_ERROR'));
                                            }
                                        );
                                    } catch (e) {
                                        // æ•è·åŒæ­¥å´©æºƒ (å¦‚ INTERSECTCLIPRECT)
                                        console.error("LuckyExcel crash:", e);
                                        reject(new Error('CRASH'));
                                    }
                                });

                                // 4. ã€æ ¸å¿ƒã€‘ç«é€Ÿï¼šè§£æ vs è¶…æ—¶
                                return Promise.race([parsingPromise, timeoutPromise]);
                            })
                                .then(exportJson => {
                                    // --- ç«é€Ÿèƒœåˆ©ï¼šè§£ææˆåŠŸ ---
                                    console.log("[Iframe] âœ… LuckyExcel è§£æäºŒè¿›åˆ¶æ–‡ä»¶æˆåŠŸï¼");
                                    const sheets = exportJson.sheets || [];
                                    const name = (exportJson.info && exportJson.info.name) || fileName;
                                    renderSheet(sheets, name, options);
                                })
                                .catch(err => {
                                    // --- ç«é€Ÿå¤±è´¥ï¼šè¶…æ—¶æˆ–æŠ¥é”™ ---
                                    console.error("[Iframe] âŒ è§£ææœ€ç»ˆå¤±è´¥:", err);

                                    let displayMsg = "æ­¤è¡¨æ ¼æ ¼å¼æœ‰é—®é¢˜ï¼Œæ— æ³•è§£æ";
                                    let subMsg = "æ–‡ä»¶å¯èƒ½åŒ…å«ä¸æ”¯æŒçš„å›¾å½¢/å…¬å¼æˆ–å·²æŸå";

                                    if (err.message === 'TIMEOUT') {
                                        displayMsg = "æ–‡ä»¶è§£æè¶…æ—¶ (10ç§’)";
                                        subMsg = "æ–‡ä»¶è¿‡äºå¤æ‚ï¼Œè¯·å°è¯•ç®€åŒ–æ ¼å¼åæŸ¥çœ‹æˆ–è€…ä¸‹è½½";
                                    }

                                    // A. Iframe ç•Œé¢æ˜¾ç¤ºçº¢å±é”™è¯¯
                                    container.innerHTML = `
                            <div style="display:flex;flex-direction:column;justify-content:center;align-items:center;height:100%;background:#fff2f0;color:#cf1322;padding:20px;text-align:center;">
                                <h3 style="margin-bottom:10px;font-size:18px;">âŒ ${displayMsg}</h3>
                                <p style="font-size:14px;color:#666;">${subMsg}</p>
                            </div>
                        `;

                                    // B. é€šçŸ¥çˆ¶çª—å£ (Vue) åœæ­¢ Loading å¹¶æŠ¥é”™
                                    window.parent.postMessage({
                                        type: 'LUCKYSHEET_RENDER_FINISHED',
                                        status: 'error',
                                        message: displayMsg
                                    }, window.location.origin);
                                });
                        }); // fetch çš„ catch ç»“æŸ
                })
                .catch(error => {
                    console.error("[Iframe] âŒ åŠ è½½æ–‡ä»¶å¤±è´¥:", error);
                    container.innerHTML = `<div class="loader">æ–‡ä»¶åŠ è½½å¤±è´¥ã€‚</div>`;
                });
        }

        /**
         * èåˆéªŒè¯è§„åˆ™
         */
        function mergeDataWithValidation(liveSheets, validationRules) {
            return liveSheets.map(liveSheet => {
                if (liveSheet && liveSheet.order != null && validationRules[liveSheet.order]) {
                    if (!liveSheet.dataVerification || Object.keys(liveSheet.dataVerification).length === 0) {
                        liveSheet.dataVerification = validationRules[liveSheet.order];
                    }
                }
                return liveSheet;
            });
        }

        /**
         * è§¦å‘æ–‡ä»¶ä¸‹è½½
         */
        function downloadBlob(blob, fileName) {
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.href = url;
            link.download = fileName;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        /**
         * å¤„ç†å¯¼å‡º
         */
        async function handleExport(fileName) {
            console.log("[Iframe] å¼€å§‹å¤ç”¨ exportWithExcelJS çš„å¯¼å‡ºæµç¨‹...");
            const loaderDiv = document.createElement('div');
            loaderDiv.className = 'loader';
            loaderDiv.style.cssText = 'position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(255, 255, 255, 0.8); z-index: 10000;';
            loaderDiv.textContent = 'æ­£åœ¨ç”ŸæˆExcelæ–‡ä»¶ï¼Œè¯·ç¨å€™...';
            container.appendChild(loaderDiv);

            try {
                const allSheetsData = luckysheet.getAllSheets();
                const blob = await exportWithExcelJS(allSheetsData);
                downloadBlob(blob, fileName);
                console.log("[Iframe] é€šè¿‡å¤ç”¨æ¨¡å—ï¼ŒæˆåŠŸå¯¼å‡ºæ–‡ä»¶ï¼");
            } catch (error) {
                console.error("[Iframe] å¤ç”¨å¯¼å‡ºæ¨¡å—æ—¶å‡ºé”™:", error);
                alert("å¯¼å‡ºæ–‡ä»¶æ—¶å‘ç”Ÿé”™è¯¯ï¼Œè¯¦æƒ…è¯·æŸ¥çœ‹æ§åˆ¶å°ã€‚");
            } finally {
                container.removeChild(loaderDiv);
            }
        }

        // --- [5. äº‹ä»¶ç›‘å¬å™¨] ---

        window.addEventListener('message', function (event) {
            if (event.origin !== window.location.origin) return;
            const { type, payload } = event.data;
            // console.log(`[Iframe] æ”¶åˆ°æ¶ˆæ¯: type=${type}`, payload);

            if (type === 'LOAD_SHEET') {
                if (payload.luckysheetData) {
                    renderSheet(payload.luckysheetData, payload.fileName, payload.options);
                } else {
                    loadSheetFromFile(payload.fileUrl, payload.fileName, payload.options);
                }
            } else if (type === 'GET_DATA_AND_IMAGES') {
                try {
                    console.group("ğŸš€ [Iframe] æ”¶åˆ°æå–æ•°æ®æŒ‡ä»¤");

                    // 1. æ ¸å¿ƒåŠ¨ä½œï¼šå¼ºåˆ¶é€€å‡ºç¼–è¾‘æ¨¡å¼
                    // (å¦‚æœä¸åšè¿™ä¸€æ­¥ï¼Œæ­£åœ¨ç¼–è¾‘çš„å•å…ƒæ ¼å†…å®¹å’ŒéªŒè¯è§„åˆ™ä¸ä¼šä¿å­˜)
                    if (window.luckysheet && window.luckysheet.exitEditMode) {
                        window.luckysheet.exitEditMode();
                        console.log("-> å·²æ‰§è¡Œ exitEditModeï¼Œç¡®ä¿æ•°æ®å·²æäº¤");
                    }

                    // 2. è·å–åŸå§‹æ•°æ® (æ·±æ‹·è´ä»¥é˜²å¼•ç”¨é—®é¢˜)
                    const rawSheets = window.luckysheet.getAllSheets();
                    const sheets = JSON.parse(JSON.stringify(rawSheets));
                    if (rawSheets && rawSheets.length > 0) {
                        const firstSheet = rawSheets[0];
                        const hasBorder = firstSheet.config && firstSheet.config.borderInfo && firstSheet.config.borderInfo.length > 0;
                        console.log(`ğŸ•µï¸ [Save Check] Sheet1 è¾¹æ¡†æ£€æŸ¥:`,
                            hasBorder ? `âœ… å­˜åœ¨ ${firstSheet.config.borderInfo.length} æ¡è§„åˆ™` : "âŒ æ— è¾¹æ¡†ä¿¡æ¯ (ä¸ºç©º)");

                        if (hasBorder) {
                            console.log("   -> è¾¹æ¡†æ•°æ®å¿«ç…§:", JSON.parse(JSON.stringify(firstSheet.config.borderInfo)));
                        }
                    }
                    // 3. [è°ƒè¯•æ¢é’ˆ] æ£€æŸ¥ç¬¬ä¸€å¼ è¡¨çš„æ•°æ®éªŒè¯æ˜¯å¦å­˜åœ¨
                    if (sheets.length > 0) {
                        const firstSheet = sheets[0];
                        // å…¼å®¹æ£€æŸ¥: dataVerification å¯èƒ½åœ¨æ ¹ç›®å½•ï¼Œä¹Ÿå¯èƒ½åœ¨ config é‡Œ
                        const rules = firstSheet.dataVerification || (firstSheet.config && firstSheet.config.dataVerification);

                        if (rules) {
                            const count = Object.keys(rules).length;
                            console.log(`âœ… [Iframeæ•°æ®æ£€æŸ¥] Sheet1 åŒ…å« ${count} æ¡éªŒè¯è§„åˆ™`);
                            if (count > 0) console.log("-> è§„åˆ™å¿«ç…§:", rules);
                        } else {
                            console.warn("âš ï¸ [Iframeæ•°æ®æ£€æŸ¥] Sheet1 æ²¡æœ‰æ£€æµ‹åˆ°éªŒè¯è§„åˆ™ (dataVerification ä¸ºç©º)");
                        }
                    }

                    // 4. å‘é€æ•°æ®å›çˆ¶çª—å£
                    const responsePayload = {
                        type: 'SHEET_DATA_WITH_IMAGES_RESPONSE',
                        payload: {
                            fileId: payload.fileId,
                            documentType: payload.documentType,
                            purpose: payload.purpose,
                            sheets: sheets, // ğŸ‘ˆ å…³é”®ï¼šè¿™é‡Œä¼ çš„æ˜¯çº¯å‡€çš„ sheets æ•°æ®
                            images: window.luckysheet.getLuckysheetfile()[0].images
                        }
                    };

                    console.log("-> æ•°æ®æ‰“åŒ…å®Œæ¯•ï¼Œå‘é€å›çˆ¶çª—å£...");
                    event.source.postMessage(responsePayload, event.origin);
                    console.groupEnd();

                } catch (e) {
                    console.error('[Iframe] è·å–æ•°æ®å¤±è´¥:', e);
                }
                return;
            } else if (type === 'EXPORT_SHEET') {
                if (window.luckysheet) {
                    handleExport(payload.fileName || 'å¯¼å‡ºæ–‡ä»¶.xlsx');
                }
            }
        });

        document.body.addEventListener('mousedown', () => {
            window.parent.postMessage({ type: 'IFRAME_CLICKED' }, window.location.origin);
        }, true);

        // --- [æ–°å¢åŠŸèƒ½ï¼šCtrl + æ»šè½®ç¼©æ”¾ (é˜²æŠ– + é˜»æ­¢æ»šåŠ¨ç‰ˆ)] ---
        // ä½¿ç”¨ capture: true (æ•è·æ¨¡å¼) ç¡®ä¿æˆ‘ä»¬åœ¨ Luckysheet å†…éƒ¨é€»è¾‘ä¹‹å‰æ‹¦æˆªäº‹ä»¶
        document.addEventListener('wheel', function (event) {

            // 1. åªæœ‰æŒ‰ä½ Ctrl æ—¶æ‰ä»‹å…¥
            if (event.ctrlKey) {

                // ã€æ ¸å¿ƒä¿®æ­£ã€‘ä¸‰è¿å‡»ï¼Œå½»åº•æ€ç­æ»šåŠ¨äº‹ä»¶
                event.preventDefault();           // 1. é˜»æ­¢æµè§ˆå™¨é»˜è®¤çš„é¡µé¢æ»šåŠ¨
                event.stopPropagation();          // 2. é˜»æ­¢äº‹ä»¶å‘ä¸Šå†’æ³¡
                event.stopImmediatePropagation(); // 3. ã€å…³é”®ã€‘é˜»æ­¢ Luckysheet å†…éƒ¨çš„æ»šåŠ¨ç›‘å¬å™¨æ‰§è¡Œ

                // --- ä¸‹é¢æ˜¯èŠ‚æµä¸ç¼©æ”¾é€»è¾‘ (ä¿æŒä¸å˜) ---

                // èŠ‚æµé”æ£€æŸ¥
                if (window._isZoomLocked) return;

                const btnMinus = document.getElementById('luckysheet-zoom-minus');
                const btnPlus = document.getElementById('luckysheet-zoom-plus');

                if (!btnMinus || !btnPlus) return;

                // ä¸Šé”
                window._isZoomLocked = true;

                // æ‰§è¡Œç¼©æ”¾
                // console.log(`[Zoom] è§¦å‘ç¼©æ”¾ (å·²æ‹¦æˆªæ»šåŠ¨)`);
                if (event.deltaY < 0) {
                    btnPlus.click();
                } else {
                    btnMinus.click();
                }

                // 100ms åè§£é”
                setTimeout(() => {
                    window._isZoomLocked = false;
                }, 100);
            }
            // å¦‚æœæ²¡æŒ‰ Ctrlï¼Œä»€ä¹ˆéƒ½ä¸åšï¼Œè®© Luckysheet æ­£å¸¸å¤„ç†æ»šåŠ¨

        }, { passive: false, capture: true }); // â˜… capture: true éå¸¸é‡è¦ï¼Œä¿è¯æˆ‘ä»¬ç¬¬ä¸€ä¸ªæ‹¿åˆ°äº‹ä»¶

        console.log('[Iframe] åŠ è½½å™¨å·²å°±ç»ªï¼Œç­‰å¾…æ¶ˆæ¯...');

    </script>
</body>

</html>