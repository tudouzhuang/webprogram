<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>Luckysheet Iframe Loader</title>
    <link rel='stylesheet' href='/luckysheet/plugins/css/pluginsCss.css' />
    <link rel='stylesheet' href='/luckysheet/css/luckysheet.css' />
    <style>
        html, body, #luckysheet-container { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; }
        .loader { text-align: center; padding-top: 20%; font-family: sans-serif; color: #888; }
    </style>
</head>
<body>
    <div id="luckysheet-container">
        <div class="loader">正在初始化加载器...</div>
    </div>

    <script src="/luckysheet/plugins/js/plugin.js"></script>
    <script src="/luckysheet/luckysheet.umd.js"></script>
    <script src="/luckysheet/luckyexcel.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

    <script>
        const container = document.getElementById('luckysheet-container');

        window.addEventListener('message', function(event) {
            if (event.origin !== window.location.origin) return;
            const { type, payload } = event.data;
            if (type === 'LOAD_SHEET') {
                loadSheet(payload.fileUrl, payload.options);
            }
        });

        /**
         * 【核心修正】: 改造 loadSheet 函数
         * 先用 fetch 下载文件为 Blob，再将 Blob 交给 LuckyExcel 解析
         */
        function loadSheet(fileUrl, options) {
            if (!fileUrl) return;

            if (typeof LuckyExcel === 'undefined' || typeof luckysheet === 'undefined') {
                container.innerHTML = '<div class="loader">错误: Luckysheet核心库未能加载。</div>';
                return;
            }

            container.innerHTML = '<div class="loader">正在下载文件...</div>';
            console.log(`[Iframe] 准备使用 fetch 从URL下载: ${fileUrl}`);

            // 1. 使用 fetch API 下载文件，并明确要求返回一个 Blob 对象
            fetch(fileUrl)
                .then(response => {
                    if (!response.ok) {
                        // 如果HTTP状态码不是2xx，则抛出错误
                        throw new Error(`网络响应错误: ${response.status} ${response.statusText}`);
                    }
                    return response.blob(); // 将响应体转换为 Blob
                })
                .then(fileBlob => {
                    // --- 文件下载成功 ---
                    container.innerHTML = '<div class="loader">下载成功，正在转换文件...</div>';
                    console.log(`[Iframe] 文件下载成功，得到 Blob 对象，准备交给 LuckyExcel 解析。`);
                    
                    // 2. 将获取到的 Blob 对象传递给 LuckyExcel
                    LuckyExcel.transformExcelToLucky(
                        fileBlob, // <-- 【关键】这里传入的是 Blob，而不是 URL 字符串
                        function(exportJson, luckysheetfile) {
                            console.log(`[Iframe] 文件转换成功。`, exportJson);
                            container.innerHTML = '';
                            if (window.luckysheet) luckysheet.destroy();
                            if (!exportJson.sheets || exportJson.sheets.length === 0) {
                                container.innerHTML = '<div class="loader">错误: 文件内容为空或格式无法解析。</div>';
                                return;
                            }
                            
                            const finalOptions = Object.assign({
                                container: 'luckysheet-container',
                                data: exportJson.sheets,
                                title: exportJson.info.name
                            }, options);
                            
                            luckysheet.create(finalOptions);
                        },
                        function(error) {
                            console.error(`[Iframe] LuckyExcel 解析 Blob 时失败:`, error);
                            container.innerHTML = `<div class="loader">文件解析失败，可能是文件格式损坏。</div>`;
                        }
                    );
                })
                .catch(error => {
                    // --- 文件下载失败 ---
                    console.error(`[Iframe] 使用 fetch 下载文件 ${fileUrl} 时失败:`, error);
                    container.innerHTML = `<div class="loader">文件下载失败，请检查URL是否正确以及网络连接。</div>`;
                    window.parent.postMessage({
                        type: 'SHEET_LOAD_ERROR',
                        payload: { error: `文件 ${fileUrl} 下载失败` }
                    }, window.location.origin);
                });
        }
    </script>
</body>
</html>